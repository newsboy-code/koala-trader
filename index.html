<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ Newsboy Koala Trader - P2P Card Game</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333;
        }
        header { background: #fff; width: 100%; max-width: 1200px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px; text-align: center; }
        header h1 { font-size: 2.5em; color: #2c3e50; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        header p { color: #7f8c8d; font-size: 1.1em; }

        #connection-screen { background: #fff; width: 100%; max-width: 600px; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; }
        .connection-buttons { display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .btn { padding: 15px 30px; font-size: 1.2em; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .connection-info { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; display: none; }
        .connection-info.active { display: block; }
        .peer-id-display { font-size: 1.5em; color: #667eea; font-weight: bold; margin: 10px 0; word-break: break-all; }
        input[type="text"] { width: 100%; padding: 15px; font-size: 1.1em; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px; }
        .status-message { margin-top: 15px; padding: 15px; border-radius: 10px; font-weight: bold; display: none; }
        .status-message.success { background: #d4edda; color: #155724; display: block; }
        .status-message.error { background: #f8d7da; color: #721c24; display: block; }
        .status-message.info { background: #d1ecf1; color: #0c5460; display: block; }

        #game-screen { display: none; width: 100%; max-width: 1200px; }
        #game-screen.active { display: block; }
        .scoreboard { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .player-score { text-align: center; padding: 15px; border-radius: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .player-score.current-turn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 0 20px rgba(102,126,234,0.5); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .score-value { font-size: 2.5em; font-weight: bold; }
        .game-info { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .token-display { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
        .token-item { padding: 10px 15px; background: #f8f9fa; border-radius: 8px; font-size: 1.2em; }
        .game-board { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .opponent-area, .market-area, .player-area { margin-bottom: 20px; padding: 20px; border-radius: 10px; background: #f8f9fa; }
        .area-title { font-size: 1.5em; font-weight: bold; margin-bottom: 15px; color: #2c3e50; text-align: center; }
        .card-container { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; min-height: 80px; }
        .card { width: 70px; height: 100px; background: #fff; border: 3px solid #dee2e6; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 2.5em; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; }
        .card:hover { transform: translateY(-10px); }
        .card.selected { border-color: #667eea; background: #f0f4ff; transform: translateY(-10px) scale(1.1); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.5); }
        .card.back { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1em; }
        .card.disabled { opacity: 0.5; cursor: not-allowed; }
        .action-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .action-btn { padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: bold; }
        .action-btn.take { background: #4facfe; color: white; }
        .action-btn.exchange { background: #43e97b; color: white; }
        .action-btn.sell { background: #fa709a; color: white; }
        .action-btn.koala-rush { background: #ff9a9e; color: #333; }
        .action-btn.end-turn { background: #a8edea; color: #333; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; }
        .sell-option { padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; }
        .sell-option:hover { background: #e9ecef; }
        .game-over { text-align: center; padding: 30px; background: #667eea; color: white; border-radius: 15px; margin-top: 20px; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ¨ Newsboy Koala Trader</h1>
        <p>ğŸ“° ê¸°ìë“¤ì˜ íŠ¹ì¢… ê²½ìŸ! ìì´í‘¸ë¥´ ë£° ê¸°ë°˜ P2P ì¹´ë“œ ê²Œì„</p>
    </header>

    <div id="connection-screen">
        <h2>ğŸ”— ê²Œì„ ì—°ê²°</h2>
        <div class="connection-buttons">
            <button class="btn btn-primary" onclick="createGame()">ğŸ® ê²Œì„ ë§Œë“¤ê¸° (Host)</button>
            <button class="btn btn-secondary" onclick="showJoinForm()">ğŸš€ ê²Œì„ ì°¸ê°€ (Guest)</button>
        </div>
        <div id="host-info" class="connection-info">
            <p>ë‹¹ì‹ ì˜ ê²Œì„ ID (í´ë¦­ ì‹œ ë³µì‚¬):</p>
            <div class="peer-id-display" id="my-peer-id" onclick="copyId()" style="cursor:pointer;">ì—°ê²° ì¤‘...</div>
            <p>ìƒëŒ€ë°©ì´ ì ‘ì†í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            <div class="status-message" id="host-status"></div>
        </div>
        <div id="guest-form" class="connection-info">
            <p>Hostì˜ ê²Œì„ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:</p>
            <input type="text" id="peer-id-input" placeholder="Host ID ì…ë ¥">
            <button class="btn btn-primary" onclick="joinGame()">ì ‘ì†í•˜ê¸°</button>
            <div class="status-message" id="guest-status"></div>
        </div>
    </div>

    <div id="game-screen">
        <div class="scoreboard">
            <div class="player-score" id="player1-score">
                <h3 id="player1-name">í”Œë ˆì´ì–´ 1</h3>
                <div class="score-value">ğŸŸ¡ <span id="p1-score">0</span></div>
                <div>ğŸ† <span id="p1-seals">0</span></div>
            </div>
            <div class="player-score" id="player2-score">
                <h3 id="player2-name">í”Œë ˆì´ì–´ 2</h3>
                <div class="score-value">ğŸŸ¡ <span id="p2-score">0</span></div>
                <div>ğŸ† <span id="p2-seals">0</span></div>
            </div>
        </div>

        <div class="game-info">
            <div><strong>ë± ë‚¨ì€ ì¹´ë“œ:</strong> <span id="deck-count">0</span>ì¥</div>
            <div class="token-display">
                <div class="token-item">ğŸ’ <span id="token-diamond">5</span></div>
                <div class="token-item">ğŸ’° <span id="token-gold">5</span></div>
                <div class="token-item">ğŸ¥ˆ <span id="token-silver">5</span></div>
                <div class="token-item">ğŸ§¶ <span id="token-cloth">7</span></div>
                <div class="token-item">ğŸŒ¶ï¸ <span id="token-spice">7</span></div>
                <div class="token-item">ğŸ‘œ <span id="token-leather">7</span></div>
            </div>
        </div>

        <div class="game-board">
            <div class="opponent-area">
                <div class="area-title">ğŸ© ìƒëŒ€ ì†íŒ¨</div>
                <div class="card-container" id="opponent-hand"></div>
            </div>
            <div class="market-area">
                <div class="area-title">ğŸª ì‹œì¥</div>
                <div class="card-container" id="market"></div>
            </div>
            <div class="player-area">
                <div class="area-title">âœ‹ ë‚´ ì†íŒ¨</div>
                <div class="card-container" id="my-hand"></div>
            </div>
            <div class="action-buttons">
                <button class="action-btn take" onclick="takeCard()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="action-btn exchange" onclick="exchangeCards()">ğŸ”„ êµí™˜í•˜ê¸°</button>
                <button class="action-btn sell" onclick="openSellModal()">ğŸ’° íŒë§¤í•˜ê¸°</button>
                <button class="action-btn koala-rush" onclick="koalaRush()">ğŸ¨ ì½”ì•Œë¼ ëª°ì´</button>
                <button class="action-btn end-turn" onclick="endTurn()">âœ… í„´ ì¢…ë£Œ</button>
            </div>
        </div>
    </div>

    <div id="sell-modal" class="modal">
        <div class="modal-content">
            <h2>ğŸ’° íŒë§¤í•  ìƒí’ˆ ì„ íƒ</h2>
            <div id="sell-options"></div>
            <button class="btn btn-primary" onclick="closeSellModal()" style="width:100%; margin-top:10px;">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        /* --- ê²Œì„ ì„¤ì • ë° ë°ì´í„° --- */
        const CARD_EMOJI = { koala: 'ğŸ¨', diamond: 'ğŸ’', gold: 'ğŸ’°', silver: 'ğŸ¥ˆ', cloth: 'ğŸ§¶', spice: 'ğŸŒ¶ï¸', leather: 'ğŸ‘œ' };
        const INITIAL_TOKENS = { diamond: 5, gold: 5, silver: 5, cloth: 7, spice: 7, leather: 7 };
        const TOKEN_VALUES = {
            diamond: [7, 7, 5, 5, 5], gold: [6, 6, 5, 5, 5], silver: [5, 5, 5, 5, 5],
            cloth: [5, 3, 3, 2, 2, 1, 1], spice: [5, 3, 3, 2, 2, 1, 1], leather: [4, 3, 2, 1, 1, 1, 1]
        };
        const BONUS_POINTS = { 3: 1, 4: 4, 5: 8, 6: 12, 7: 16 };

        let peer = null, connection = null, isHost = false, myPlayerId = null;
        let gameState = {
            deck: [], market: [], player1Hand: [], player2Hand: [],
            player1Score: 0, player2Score: 0, player1Seals: 0, player2Seals: 0,
            tokens: JSON.parse(JSON.stringify(INITIAL_TOKENS)),
            currentTurn: 1, selectedCards: { myHand: [], market: [] },
            actionTaken: false, gameOver: false
        };

        /* --- PeerJS ì„¤ì • ë° P2P í†µì‹  --- */
        const peerConfig = {
            host: '0.peerjs.com', port: 443, path: '/', secure: true,
            config: { 'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] }
        };

        function createGame() {
            peer = new Peer(undefined, peerConfig);
            isHost = true; myPlayerId = 1;
            peer.on('open', (id) => {
                document.getElementById('my-peer-id').textContent = id;
                document.getElementById('host-info').classList.add('active');
                showStatus('host-status', 'ìƒëŒ€ë°©ì˜ ì ‘ì†ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤...', 'info');
            });
            peer.on('connection', (conn) => {
                connection = conn;
                setupConnection();
                showStatus('host-status', 'âœ… ìƒëŒ€ë°© ì—°ê²° ì„±ê³µ! ì ì‹œ í›„ ê²Œì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.', 'success');
                setTimeout(() => { initializeGame(); startGame(); }, 1500);
            });
        }

        function showJoinForm() { document.getElementById('guest-form').classList.add('active'); }

        function joinGame() {
            const hostId = document.getElementById('peer-id-input').value.trim();
            if (!hostId) return alert('Host IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            peer = new Peer(undefined, peerConfig);
            isHost = false; myPlayerId = 2;
            peer.on('open', () => {
                showStatus('guest-status', 'ì—°ê²° ì‹œë„ ì¤‘...', 'info');
                connection = peer.connect(hostId, { reliable: true });
                setupConnection();
            });
            peer.on('error', (err) => showStatus('guest-status', `âŒ ì—°ê²° ì‹¤íŒ¨: ${err.type}`, 'error'));
        }

        function setupConnection() {
            connection.on('open', () => {
                console.log('P2P í†µë¡œ ê°œì„¤ ì™„ë£Œ');
                if (!isHost) {
                    showStatus('guest-status', 'âœ… ì—°ê²° ì„±ê³µ! ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...', 'success');
                    setTimeout(() => { if(!gameState.deck.length) sendAction({type:'requestSync'}); }, 2000);
                }
            });
            connection.on('data', handleReceivedData);
            connection.on('close', () => { alert('ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.'); location.reload(); });
        }

        function handleReceivedData(data) {
            console.log('ë°ì´í„° ìˆ˜ì‹ :', data.type);
            if (data.type === 'gameState') {
                gameState = data.state;
                renderGame();
                if (document.getElementById('game-screen').style.display !== 'block') {
                    startGame();
                }
            } else if (data.type === 'action' && isHost) {
                if (data.action.type === 'requestSync') sendGameState();
                else handleGuestAction(data.action);
            }
        }

        function sendGameState() { if (connection && connection.open) connection.send({ type: 'gameState', state: gameState }); }
        function sendAction(action) { if (connection && connection.open) connection.send({ type: 'action', action: action }); }
        function showStatus(id, msg, type) { const el = document.getElementById(id); el.textContent = msg; el.className = `status-message ${type}`; }
        function copyId() { const id = document.getElementById('my-peer-id').textContent; navigator.clipboard.writeText(id).then(()=>alert("IDê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.")); }

        /* --- ê²Œì„ ì—”ì§„ ë¡œì§ --- */
        function createDeck() {
            const deck = [];
            const counts = { diamond: 6, gold: 6, silver: 6, cloth: 8, spice: 8, leather: 10, koala: 11 };
            for (let type in counts) for (let i = 0; i < counts[type]; i++) deck.push(type);
            return deck.sort(() => Math.random() - 0.5);
        }

        function initializeGame() {
            gameState.deck = createDeck();
            gameState.player1Hand = gameState.deck.splice(0, 5);
            gameState.player2Hand = gameState.deck.splice(0, 5);
            gameState.market = ['koala', 'koala', 'koala'];
            let remain = gameState.deck.filter(c => c !== 'koala');
            gameState.market.push(remain.shift(), remain.shift());
            gameState.deck = gameState.deck.filter(c => !gameState.market.includes(c) || c === 'koala');
            gameState.tokens = JSON.parse(JSON.stringify(INITIAL_TOKENS));
            gameState.currentTurn = 1;
            gameState.actionTaken = false;
            gameState.selectedCards = { myHand: [], market: [] };
        }

        function startGame() {
            document.getElementById('connection-screen').style.display = 'none';
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('player1-name').textContent = isHost ? 'ë‚˜ (Host)' : 'ìƒëŒ€ (Host)';
            document.getElementById('player2-name').textContent = isHost ? 'ìƒëŒ€ (Guest)' : 'ë‚˜ (Guest)';
            renderGame();
            if (isHost) sendGameState();
        }

        /* --- ë Œë”ë§ ë° UI ì¡°ì‘ --- */
        function renderGame() {
            document.getElementById('p1-score').textContent = gameState.player1Score;
            document.getElementById('p2-score').textContent = gameState.player2Score;
            document.getElementById('p1-seals').textContent = gameState.player1Seals;
            document.getElementById('p2-seals').textContent = gameState.player2Seals;
            document.getElementById('deck-count').textContent = gameState.deck.length;

            ['diamond','gold','silver','cloth','spice','leather'].forEach(t => {
                document.getElementById(`token-${t}`).textContent = gameState.tokens[t];
            });

            const p1ScoreEl = document.getElementById('player1-score');
            const p2ScoreEl = document.getElementById('player2-score');
            if(gameState.currentTurn === 1) { p1ScoreEl.classList.add('current-turn'); p2ScoreEl.classList.remove('current-turn'); }
            else { p1ScoreEl.classList.remove('current-turn'); p2ScoreEl.classList.add('current-turn'); }

            renderArea('market', gameState.market, 'market');
            renderArea('my-hand', isHost ? gameState.player1Hand : gameState.player2Hand, 'hand');
            renderOpponent();
            updateButtonStates();
            if (gameState.gameOver) showGameOver();
        }

        function renderArea(id, cards, location) {
            const el = document.getElementById(id);
            el.innerHTML = '';
            cards.forEach((card, i) => {
                const div = document.createElement('div');
                div.className = `card ${gameState.selectedCards[location === 'hand' ? 'myHand' : 'market'].includes(i) ? 'selected' : ''}`;
                if (gameState.currentTurn !== myPlayerId) div.classList.add('disabled');
                div.textContent = CARD_EMOJI[card];
                div.onclick = () => { if(gameState.currentTurn === myPlayerId) toggleSelect(i, location); };
                el.appendChild(div);
            });
        }

        function renderOpponent() {
            const el = document.getElementById('opponent-hand');
            el.innerHTML = '';
            const count = isHost ? gameState.player2Hand.length : gameState.player1Hand.length;
            for(let i=0; i<count; i++) {
                const div = document.createElement('div');
                div.className = 'card back';
                div.textContent = 'ğŸ“°';
                el.appendChild(div);
            }
        }

        function toggleSelect(idx, loc) {
            const arr = loc === 'hand' ? gameState.selectedCards.myHand : gameState.selectedCards.market;
            const p = arr.indexOf(idx);
            if(p > -1) arr.splice(p, 1); else arr.push(idx);
            renderGame();
        }

        function updateButtonStates() {
            const btns = document.querySelectorAll('.action-btn');
            btns.forEach(b => b.disabled = (gameState.currentTurn !== myPlayerId || gameState.actionTaken || gameState.gameOver));
        }

        /* --- í–‰ë™ ë¡œì§ --- */
        function takeCard() {
            if(gameState.selectedCards.market.length !== 1) return alert('ì‹œì¥ ê¸°ì‚¬ 1ê°œë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            const hand = isHost ? (myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand) : (myPlayerId === 2 ? gameState.player2Hand : gameState.player1Hand);
            if(hand.length >= 7) return alert('ìˆ˜ì²©ì´ ê½‰ ì°¼ìŠµë‹ˆë‹¤.');
            const act = { type: 'take', marketIndex: gameState.selectedCards.market[0] };
            isHost ? executeTakeCard(act) : sendAction(act);
        }

        function executeTakeCard(act) {
            const hand = gameState.currentTurn === 1 ? gameState.player1Hand : gameState.player2Hand;
            hand.push(gameState.market.splice(act.marketIndex, 1)[0]);
            if(gameState.deck.length > 0) gameState.market.splice(act.marketIndex, 0, gameState.deck.shift());
            clearSelections();
            finishAction('take');
        }

        function exchangeCards() {
            const mCount = gameState.selectedCards.market.length;
            const hCount = gameState.selectedCards.myHand.length;
            if(mCount < 2 || mCount !== hCount) return alert('êµí™˜í•  ì¹´ë“œ ìˆ˜ê°€ ì¼ì¹˜í•˜ì§€ ì•Šê±°ë‚˜ 2ì¥ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            const act = { type: 'exchange', handIndices: [...gameState.selectedCards.myHand].sort((a,b)=>b-a), marketIndices: [...gameState.selectedCards.market].sort((a,b)=>b-a) };
            isHost ? executeExchange(act) : sendAction(act);
        }

        function executeExchange(act) {
            const hand = gameState.currentTurn === 1 ? gameState.player1Hand : gameState.player2Hand;
            const fromHand = act.handIndices.map(i => hand.splice(i, 1)[0]);
            const fromMarket = act.marketIndices.map(i => gameState.market.splice(i, 1)[0]);
            act.marketIndices.reverse().forEach((mi, i) => gameState.market.splice(mi, 0, fromHand[i]));
            fromMarket.forEach(c => hand.push(c));
            clearSelections();
            finishAction('exchange');
        }

        function koalaRush() {
            const count = gameState.market.filter(c => c === 'koala').length;
            if(count === 0) return alert('ì‹œì¥ì— ì½”ì•Œë¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            const act = { type: 'koalaRush' };
            isHost ? executeKoalaRush(act) : sendAction(act);
        }

        function executeKoalaRush() {
            const hand = gameState.currentTurn === 1 ? gameState.player1Hand : gameState.player2Hand;
            for(let i=gameState.market.length-1; i>=0; i--) {
                if(gameState.market[i] === 'koala') {
                    hand.push(gameState.market.splice(i, 1)[0]);
                    if(gameState.deck.length > 0) gameState.market.splice(i, 0, gameState.deck.shift());
                }
            }
            clearSelections();
            finishAction('koalaRush');
        }

        function openSellModal() {
            const hand = myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand;
            const groups = {}; hand.forEach(c => { if(c!=='koala') groups[c] = (groups[c]||0)+1; });
            const ops = [];
            for(let t in groups) {
                const min = ['diamond','gold','silver'].includes(t) ? 2 : 1;
                if(groups[t] >= min) ops.push({ type: t, count: groups[t] });
            }
            if(ops.length === 0) return alert('íŒë§¤í•  ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
            const el = document.getElementById('sell-options'); el.innerHTML = '';
            ops.forEach(o => {
                const div = document.createElement('div'); div.className = 'sell-option';
                div.innerHTML = `<span>${CARD_EMOJI[o.type]} ${o.count}ì¥</span><span>ğŸ’° íŒë§¤</span>`;
                div.onclick = () => { 
                    const act = { type: 'sell', goodType: o.type, count: o.count };
                    isHost ? executeSell(act) : sendAction(act);
                    closeSellModal();
                };
                el.appendChild(div);
            });
            document.getElementById('sell-modal').classList.add('active');
        }

        function closeSellModal() { document.getElementById('sell-modal').classList.remove('active'); }

        function executeSell(act) {
            const hand = gameState.currentTurn === 1 ? gameState.player1Hand : gameState.player2Hand;
            const scoreKey = gameState.currentTurn === 1 ? 'player1Score' : 'player2Score';
            let removed = 0;
            for(let i=hand.length-1; i>=0 && removed < act.count; i--) { if(hand[i] === act.goodType) { hand.splice(i, 1); removed++; } }
            
            let pts = 0;
            const available = gameState.tokens[act.goodType];
            const vals = TOKEN_VALUES[act.goodType];
            for(let i=0; i < Math.min(act.count, available); i++) { pts += vals[vals.length - available + i]; }
            gameState.tokens[act.goodType] = Math.max(0, available - act.count);
            if(BONUS_POINTS[act.count]) pts += BONUS_POINTS[act.count];
            gameState[scoreKey] += pts;
            
            checkGameOver();
            clearSelections();
            finishAction('sell');
        }

        function endTurn() { 
            const act = { type: 'endTurn' }; 
            isHost ? executeEndTurn() : sendAction(act); 
        }
        
        function executeEndTurn() { 
            gameState.currentTurn = (gameState.currentTurn === 1 ? 2 : 1); 
            gameState.actionTaken = false; 
            clearSelections();
            finishAction('endTurn'); 
        }
        
        function clearSelections() {
            gameState.selectedCards = { myHand: [], market: [] };
        }
        
        function finishAction(actionType) {
            if(isHost) {
                // í„´ ì¢…ë£Œê°€ ì•„ë‹Œ ì¼ë°˜ í–‰ë™ì¼ ê²½ìš°ë§Œ actionTakenì„ trueë¡œ
                if(actionType !== 'endTurn' && actionType !== 'requestSync') {
                    gameState.actionTaken = true;
                }
                sendGameState(); 
                renderGame();
            }
        }

        function handleGuestAction(act) {
            if(act.type === 'take') executeTakeCard(act);
            else if(act.type === 'exchange') executeExchange(act);
            else if(act.type === 'sell') executeSell(act);
            else if(act.type === 'koalaRush') executeKoalaRush(act);
            else if(act.type === 'endTurn') executeEndTurn();
        }

        function checkGameOver() {
            const empty = Object.values(gameState.tokens).filter(v => v === 0).length;
            if(empty >= 3 || gameState.deck.length === 0) gameState.gameOver = true;
        }

        function showGameOver() {
            const win = gameState.player1Score > gameState.player2Score ? 'í”Œë ˆì´ì–´ 1' : 
                        gameState.player2Score > gameState.player1Score ? 'í”Œë ˆì´ì–´ 2' : 'ë¬´ìŠ¹ë¶€';
            const winnerName = win === 'í”Œë ˆì´ì–´ 1' ? 
                (isHost ? 'ë‚˜ (Host)' : 'ìƒëŒ€ (Host)') : 
                win === 'í”Œë ˆì´ì–´ 2' ? 
                (isHost ? 'ìƒëŒ€ (Guest)' : 'ë‚˜ (Guest)') : 'ë¬´ìŠ¹ë¶€';
            if(isHost) gameState.gameOver = true;
            alert(`ğŸ‰ ê²Œì„ ì¢…ë£Œ!\n\nìŠ¹ì: ${winnerName}\ní”Œë ˆì´ì–´ 1: ${gameState.player1Score}ì \ní”Œë ˆì´ì–´ 2: ${gameState.player2Score}ì `);
        }
    </script>
</body>
</html>
