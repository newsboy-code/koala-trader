<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ Newsboy Koala Trader - P2P Card Game</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* =========================
           ì „ì—­ ìŠ¤íƒ€ì¼ ë° ë ˆì´ì•„ì›ƒ
           ========================= */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; color: #333;
        }
        header {
            background: #fff; width: 100%; max-width: 1200px; padding: 20px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px; text-align: center;
        }
        #connection-screen {
            background: #fff; width: 100%; max-width: 600px; padding: 40px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;
        }
        .connection-info { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; display: none; }
        .connection-info.active { display: block; }
        .peer-id-display { font-size: 1.5em; color: #667eea; font-weight: bold; margin: 10px 0; word-break: break-all; }
        .btn { padding: 15px 30px; font-size: 1.2em; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        
        /* ê²Œì„ í™”ë©´ ê´€ë ¨ */
        #game-screen { display: none; width: 100%; max-width: 1200px; }
        #game-screen.active { display: block; }
        .scoreboard { background: #fff; padding: 20px; border-radius: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .player-score { text-align: center; padding: 15px; border-radius: 10px; background: #eee; transition: 0.5s; }
        .player-score.current-turn { background: #667eea; color: white; transform: scale(1.02); box-shadow: 0 0 15px rgba(102,126,234,0.5); }
        .score-value { font-size: 2em; font-weight: bold; }

        .game-board { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .area-title { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; text-align: center; color: #555; }
        .card-container { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; min-height: 110px; padding: 10px; background: #f9f9f9; border-radius: 10px; margin-bottom: 15px; }
        
        .card {
            width: 70px; height: 100px; background: #fff; border: 2px solid #ddd; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; font-size: 2.2em; cursor: pointer; transition: 0.2s;
        }
        .card.selected { border-color: #667eea; background: #eef2ff; transform: translateY(-10px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card.back { background: #667eea; color: white; }
        .card.disabled { opacity: 0.6; cursor: default; }

        .action-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .action-btn { padding: 12px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }
        .take { background: #4facfe; } .exchange { background: #43e97b; } .sell { background: #fa709a; } .koala { background: #ff9a9e; color: #333; } .end { background: #555; }
        .action-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .status-message { margin-top: 15px; padding: 10px; border-radius: 8px; font-weight: bold; display: none; }
        .status-message.info { background: #d1ecf1; color: #0c5460; display: block; }
        .status-message.success { background: #d4edda; color: #155724; display: block; }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:100; align-items:center; justify-content:center; }
        .modal.active { display: flex; }
        .modal-content { background:#fff; padding:25px; border-radius:15px; width:90%; max-width:400px; }
        .sell-option { padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; cursor:pointer; }
        .sell-option:hover { background:#f5f5f5; }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ¨ Newsboy Koala Trader</h1>
        <p>ê¸°ìë“¤ì˜ íŠ¹ì¢… ê²½ìŸ! ìì´í‘¸ë¥´ ë£° ê¸°ë°˜ P2P ì¹´ë“œ ê²Œì„</p>
    </header>

    <div id="connection-screen">
        <h2>ğŸ”— ê²Œì„ ì—°ê²°</h2>
        <div class="connection-buttons" style="margin-top:20px;">
            <button class="btn btn-primary" onclick="createGame()">ğŸ® ê²Œì„ ë§Œë“¤ê¸° (Host)</button>
            <button class="btn btn-secondary" onclick="showJoinForm()">ğŸš€ ê²Œì„ ì°¸ê°€ (Guest)</button>
        </div>

        <div id="host-info" class="connection-info">
            <p>ìƒëŒ€ë°©ì—ê²Œ ì´ IDë¥¼ ì•Œë ¤ì£¼ì„¸ìš”:</p>
            <div class="peer-id-display" id="my-peer-id">ID ìƒì„± ì¤‘...</div>
            <div class="status-message" id="host-status"></div>
        </div>

        <div id="guest-form" class="connection-info">
            <input type="text" id="peer-id-input" placeholder="Host ID ì…ë ¥" style="width:80%; padding:10px; margin-bottom:10px;">
            <br>
            <button class="btn btn-primary" onclick="joinGame()">ì ‘ì†í•˜ê¸°</button>
            <div class="status-message" id="guest-status"></div>
        </div>
    </div>

    <div id="game-screen">
        <div class="scoreboard">
            <div class="player-score" id="p1-area">
                <h3 id="p1-label">í”Œë ˆì´ì–´ 1</h3>
                <div class="score-value">ğŸŸ¡ <span id="p1-score">0</span></div>
                <div>ğŸ† <span id="p1-seals">0</span></div>
            </div>
            <div class="player-score" id="p2-area">
                <h3 id="p2-label">í”Œë ˆì´ì–´ 2</h3>
                <div class="score-value">ğŸŸ¡ <span id="p2-score">0</span></div>
                <div>ğŸ† <span id="p2-seals">0</span></div>
            </div>
        </div>

        <div class="game-board">
            <div class="area-title">ğŸ© ìƒëŒ€ ì†íŒ¨</div>
            <div class="card-container" id="opponent-hand"></div>

            <div class="area-title">ğŸª ì‹œì¥ (ë‚¨ì€ ë±: <span id="deck-count">0</span>)</div>
            <div class="card-container" id="market-hand"></div>

            <div class="area-title">âœ‹ ë‚´ ì†íŒ¨</div>
            <div class="card-container" id="my-hand"></div>

            <div class="action-buttons">
                <button class="action-btn take" onclick="takeCard()">ğŸ“¥ 1ì¥ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="action-btn exchange" onclick="exchangeCards()">ğŸ”„ êµí™˜í•˜ê¸°</button>
                <button class="action-btn sell" onclick="openSellModal()">ğŸ’° íŒë§¤í•˜ê¸°</button>
                <button class="action-btn koala" onclick="koalaRush()">ğŸ¨ ì½”ì•Œë¼ ëª°ì´</button>
                <button class="action-btn end" onclick="endTurn()">âœ… í„´ ì¢…ë£Œ</button>
            </div>
        </div>
    </div>

    <div id="sell-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ’° ì–´ë–¤ ìƒí’ˆì„ íŒë§¤í• ê¹Œìš”?</h3>
            <div id="sell-options-list"></div>
            <button class="btn" style="width:100%; margin-top:15px;" onclick="closeSellModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        /* =============================================
           ê²Œì„ ë°ì´í„° ë° ì„¤ì •
           ============================================= */
        const CARD_EMOJI = { koala: 'ğŸ¨', diamond: 'ğŸ’', gold: 'ğŸ’°', silver: 'ğŸ¥ˆ', cloth: 'ğŸ§¶', spice: 'ğŸŒ¶ï¸', leather: 'ğŸ‘œ' };
        const PEER_CONFIG = {
            config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }, { url: 'stun:stun1.l.google.com:19302' }] }
        };

        let peer = null, conn = null, isHost = false, myId = null;
        let state = {
            deck: [], market: [], p1Hand: [], p2Hand: [],
            p1Score: 0, p2Score: 0, p1Seals: 0, p2Seals: 0,
            tokens: { diamond: 5, gold: 5, silver: 5, cloth: 7, spice: 7, leather: 7 },
            turn: 1, actionDone: false, selected: { hand: [], market: [] }
        };

        /* =============================================
           P2P ì—°ê²° ë¡œì§
           ============================================= */
        function createGame() {
            isHost = true; myId = 1;
            peer = new Peer(PEER_CONFIG);
            peer.on('open', id => {
                document.getElementById('my-peer-id').textContent = id;
                document.getElementById('host-info').classList.add('active');
                showStatus('host-status', 'ìƒëŒ€ë°© ì ‘ì† ëŒ€ê¸° ì¤‘...', 'info');
            });
            peer.on('connection', c => {
                conn = c; setupConn();
                showStatus('host-status', 'âœ… ì—°ê²° ì„±ê³µ! ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.', 'success');
                setTimeout(() => { initGame(); startGame(); }, 1000);
            });
        }

        function showJoinForm() { document.getElementById('guest-form').classList.add('active'); }

        function joinGame() {
            const hostId = document.getElementById('peer-id-input').value.trim();
            if (!hostId) return;
            isHost = false; myId = 2;
            peer = new Peer(PEER_CONFIG);
            peer.on('open', () => {
                conn = peer.connect(hostId, { reliable: true });
                setupConn();
                showStatus('guest-status', 'Host ì—°ê²° ì‹œë„ ì¤‘...', 'info');
            });
        }

        function setupConn() {
            conn.on('data', data => {
                if (data.type === 'STATE') {
                    state = data.payload;
                    if (!document.getElementById('game-screen').classList.contains('active')) startGame();
                    renderGame();
                } else if (data.type === 'ACTION' && isHost) {
                    handleAction(data.payload);
                }
            });
            conn.on('close', () => { alert('ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.'); location.reload(); });
        }

        /* =============================================
           ê²Œì„ í•µì‹¬ ì—”ì§„
           ============================================= */
        function initGame() {
            const deck = [];
            const counts = { diamond:6, gold:6, silver:6, cloth:8, spice:8, leather:10, koala:11 };
            Object.entries(counts).forEach(([type, count]) => {
                for(let i=0; i<count; i++) deck.push(type);
            });
            for(let i=deck.length-1; i>0; i--) {
                const j = Math.floor(Math.random()*(i+1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            state.p1Hand = deck.splice(0, 5);
            state.p2Hand = deck.splice(0, 5);
            state.market = ['koala', 'koala', 'koala', deck.pop(), deck.pop()];
            state.deck = deck;
            state.turn = 1;
        }

        function startGame() {
            document.getElementById('connection-screen').style.display = 'none';
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('p1-label').textContent = (myId === 1) ? "ë‚˜ (P1)" : "ìƒëŒ€ (P1)";
            document.getElementById('p2-label').textContent = (myId === 2) ? "ë‚˜ (P2)" : "ìƒëŒ€ (P2)";
            if (isHost) { sync(); renderGame(); } // Hostê°€ ì§ì ‘ í™”ë©´ì„ ê·¸ë¦¬ëŠ” ì½”ë“œ ì¶”ê°€
        }

        function renderGame() {
            // ì ìˆ˜ ë° ìƒíƒœ ê°±ì‹ 
            document.getElementById('p1-score').textContent = state.p1Score;
            document.getElementById('p2-score').textContent = state.p2Score;
            document.getElementById('deck-count').textContent = state.deck.length;
            
            document.getElementById('p1-area').className = `player-score ${state.turn === 1 ? 'current-turn' : ''}`;
            document.getElementById('p2-area').className = `player-score ${state.turn === 2 ? 'current-turn' : ''}`;

            // ë‚´ ì†íŒ¨ ë Œë”ë§
            const myHand = (myId === 1) ? state.p1Hand : state.p2Hand;
            renderCards('my-hand', myHand, 'hand');

            // ì‹œì¥ ë Œë”ë§
            renderCards('market-hand', state.market, 'market');

            // ìƒëŒ€ ì†íŒ¨ (ë’·ë©´)
            const oppHandSize = (myId === 1) ? state.p2Hand.length : state.p1Hand.length;
            const oppEl = document.getElementById('opponent-hand');
            oppEl.innerHTML = '';
            for(let i=0; i<oppHandSize; i++) {
                const c = document.createElement('div'); c.className = 'card back'; c.textContent = 'ğŸ´';
                oppEl.appendChild(c);
            }

            // ë²„íŠ¼ í™œì„±í™”
            const isMyTurn = (state.turn === myId);
            document.querySelectorAll('.action-btn').forEach(btn => {
                btn.disabled = !isMyTurn || state.actionDone;
            });
            document.querySelector('.end').disabled = !isMyTurn || !state.actionDone;
        }

        function renderCards(containerId, cards, location) {
            const el = document.getElementById(containerId);
            el.innerHTML = '';
            cards.forEach((type, idx) => {
                const c = document.createElement('div');
                const isSelected = state.selected[location].includes(idx);
                c.className = `card ${isSelected ? 'selected' : ''}`;
                c.textContent = CARD_EMOJI[type];
                c.onclick = () => {
                    if (state.turn !== myId || state.actionDone) return;
                    const list = state.selected[location];
                    const p = list.indexOf(idx);
                    if (p > -1) list.splice(p, 1); else list.push(idx);
                    renderGame();
                };
                el.appendChild(c);
            });
        }

        /* =============================================
           ê²Œì„ ì•¡ì…˜ (ê°€ì ¸ì˜¤ê¸°, êµí™˜, íŒë§¤)
           ============================================= */
        function takeCard() {
            if (state.selected.market.length !== 1) return alert('ì‹œì¥ì—ì„œ ê°€ì ¸ì˜¬ ì¹´ë“œ 1ì¥ë§Œ ì„ íƒí•˜ì„¸ìš”.');
            const myHand = (myId === 1) ? state.p1Hand : state.p2Hand;
            if (myHand.length >= 7) return alert('ì†íŒ¨ëŠ” ìµœëŒ€ 7ì¥ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            const act = { type: 'TAKE', idx: state.selected.market[0] };
            isHost ? handleAction(act) : conn.send({ type: 'ACTION', payload: act });
        }

        function exchangeCards() {
            const hCount = state.selected.hand.length, mCount = state.selected.market.length;
            if (hCount < 2 || hCount !== mCount) return alert('2ì¥ ì´ìƒì˜ ì¹´ë“œë¥¼ ê°™ì€ ê°œìˆ˜ë¡œ ì„ íƒí•´ì•¼ êµí™˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
            const act = { type: 'EXCHANGE', hIdx: [...state.selected.hand], mIdx: [...state.selected.market] };
            isHost ? handleAction(act) : conn.send({ type: 'ACTION', payload: act });
        }

        function openSellModal() {
            if (state.actionDone) return;
            const hand = (myId === 1) ? state.p1Hand : state.p2Hand;
            const counts = {}; hand.forEach(c => { if(c!=='koala') counts[c] = (counts[c]||0)+1; });
            const listEl = document.getElementById('sell-options-list');
            listEl.innerHTML = '';
            
            Object.entries(counts).forEach(([type, count]) => {
                const min = ['diamond','gold','silver'].includes(type) ? 2 : 1;
                if (count >= min) {
                    const opt = document.createElement('div'); opt.className = 'sell-option';
                    opt.innerHTML = `<span>${CARD_EMOJI[type]} ${type} (${count}ì¥)</span> <b>íŒë§¤</b>`;
                    opt.onclick = () => {
                        const act = { type: 'SELL', good: type, count: count };
                        isHost ? handleAction(act) : conn.send({ type: 'ACTION', payload: act });
                        closeSellModal();
                    };
                    listEl.appendChild(opt);
                }
            });
            if (listEl.innerHTML === '') return alert('íŒë§¤ ê°€ëŠ¥í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤ (ë³´ì„ë¥˜ëŠ” 2ì¥ ì´ìƒ í•„ìˆ˜).');
            document.getElementById('sell-modal').classList.add('active');
        }

        function koalaRush() {
            if (!state.market.includes('koala')) return alert('ì‹œì¥ì— ì½”ì•Œë¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            const act = { type: 'KOALA' };
            isHost ? handleAction(act) : conn.send({ type: 'ACTION', payload: act });
        }

        function endTurn() {
            const act = { type: 'END' };
            isHost ? handleAction(act) : conn.send({ type: 'ACTION', payload: act });
        }

        /* =============================================
           Host ì „ìš© ì•¡ì…˜ ì²˜ë¦¬ê¸°
           ============================================= */
        function handleAction(act) {
            const hand = (state.turn === 1) ? state.p1Hand : state.p2Hand;
            const scoreKey = (state.turn === 1) ? 'p1Score' : 'p2Score';

            if (act.type === 'TAKE') {
                hand.push(state.market.splice(act.idx, 1)[0]);
                if (state.deck.length > 0) state.market.push(state.deck.pop());
                state.actionDone = true;
            } else if (act.type === 'EXCHANGE') {
                const fromH = act.hIdx.sort((a,b)=>b-a).map(i => hand.splice(i, 1)[0]);
                const fromM = act.mIdx.sort((a,b)=>b-a).map(i => state.market.splice(i, 1)[0]);
                hand.push(...fromM);
                state.market.push(...fromH);
                state.actionDone = true;
            } else if (act.type === 'SELL') {
                for(let i=hand.length-1; i>=0; i--) if(hand[i] === act.good) hand.splice(i, 1);
                state[scoreKey] += (act.count * 2); // ë‹¨ìˆœ ì ìˆ˜ ê³„ì‚° (ê³ ê¸‰ ë£° ì ìš© ê°€ëŠ¥)
                state.actionDone = true;
            } else if (act.type === 'KOALA') {
                for(let i=state.market.length-1; i>=0; i--) {
                    if(state.market[i] === 'koala') hand.push(state.market.splice(i, 1)[0]);
                }
                while(state.market.length < 5 && state.deck.length > 0) state.market.push(state.deck.pop());
                state.actionDone = true;
            } else if (act.type === 'END') {
                state.turn = (state.turn === 1) ? 2 : 1;
                state.actionDone = false;
            }
            state.selected = { hand: [], market: [] };
            sync(); renderGame();
        }

        function sync() { if(conn) conn.send({ type: 'STATE', payload: state }); }
        function showStatus(id, msg, type) { const el = document.getElementById(id); el.textContent = msg; el.className = `status-message ${type}`; }
        function closeSellModal() { document.getElementById('sell-modal').classList.remove('active'); }
    </script>
</body>
</html>
