<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ Newsboy Koala Trader - P2P Card Game</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* [ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }
        header {
            background: #fff; width: 100%; max-width: 1200px; padding: 20px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px; text-align: center;
        }
        header h1 { font-size: 2.5em; color: #2c3e50; margin-bottom: 10px; }
        header p { color: #7f8c8d; font-size: 1.1em; }
        #connection-screen {
            background: #fff; width: 100%; max-width: 600px; padding: 40px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center;
        }
        #connection-screen h2 { color: #2c3e50; margin-bottom: 30px; font-size: 2em; }
        .connection-buttons { display: flex; gap: 20px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; }
        .btn { padding: 15px 30px; font-size: 1.2em; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .connection-info { margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; display: none; }
        .connection-info.active { display: block; }
        .peer-id-display { font-size: 1.5em; color: #667eea; font-weight: bold; margin: 10px 0; word-break: break-all; }
        input[type="text"] { width: 100%; padding: 15px; font-size: 1.1em; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px; }
        .status-message { margin-top: 15px; padding: 15px; border-radius: 10px; font-weight: bold; display: none; }
        .status-message.success { background: #d4edda; color: #155724; display: block; }
        .status-message.error { background: #f8d7da; color: #721c24; display: block; }
        .status-message.info { background: #d1ecf1; color: #0c5460; display: block; }
        #game-screen { display: none; width: 100%; max-width: 1200px; }
        #game-screen.active { display: block; }
        .scoreboard { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .player-score { text-align: center; padding: 15px; border-radius: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .player-score.current-turn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .score-value { font-size: 2.5em; font-weight: bold; }
        .game-info { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .token-display { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 10px; }
        .token-item { padding: 10px 15px; background: #f8f9fa; border-radius: 8px; font-size: 1.2em; }
        .game-board { background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .opponent-area, .market-area, .player-area { margin-bottom: 20px; padding: 20px; border-radius: 10px; background: #f8f9fa; }
        .area-title { font-size: 1.5em; font-weight: bold; margin-bottom: 15px; color: #2c3e50; text-align: center; }
        .card-container { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; min-height: 80px; }
        .card { width: 70px; height: 100px; background: #fff; border: 3px solid #dee2e6; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 2.5em; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .card.selected { border-color: #667eea; background: #eef2ff; transform: translateY(-10px); }
        .card.disabled { opacity: 0.5; cursor: not-allowed; }
        .card.back { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .action-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .action-btn { padding: 15px 30px; font-size: 1.1em; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .action-btn.take { background: #4facfe; color: white; }
        .action-btn.exchange { background: #43e97b; color: white; }
        .action-btn.sell { background: #fa709a; color: white; }
        .action-btn.koala-rush { background: #ff9a9e; color: #333; }
        .action-btn.end-turn { background: #a8edea; color: #333; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; }
        .sell-option { padding: 15px; margin: 10px 0; background: #f8f9fa; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; }
        .game-over { text-align: center; padding: 30px; background: #764ba2; color: white; border-radius: 15px; margin-top: 20px; }
    </style>
</head>
<body>
    <header>
        <h1>ğŸ¨ Newsboy Koala Trader</h1>
        <p>ğŸ“° ê¸°ìë“¤ì˜ íŠ¹ì¢… ê²½ìŸ! ìì´í‘¸ë¥´ ë£° ê¸°ë°˜ P2P ì¹´ë“œ ê²Œì„</p>
    </header>

    <div id="connection-screen">
        <h2>ğŸ”— ê²Œì„ ì—°ê²°</h2>
        <div class="connection-buttons">
            <button class="btn btn-primary" onclick="createGame()">ğŸ® ê²Œì„ ë§Œë“¤ê¸° (Host)</button>
            <button class="btn btn-secondary" onclick="showJoinForm()">ğŸš€ ê²Œì„ ì°¸ê°€ (Guest)</button>
        </div>
        <div id="host-info" class="connection-info">
            <p>ë‹¹ì‹ ì˜ ê²Œì„ ID:</p>
            <div class="peer-id-display" id="my-peer-id">ì—°ê²° ì¤‘...</div>
            <p>ìƒëŒ€ë°©ì´ ì´ IDë¡œ ì ‘ì†í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            <div class="status-message" id="host-status"></div>
        </div>
        <div id="guest-form" class="connection-info">
            <p>Hostì˜ ê²Œì„ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:</p>
            <input type="text" id="peer-id-input" placeholder="Host ID ì…ë ¥">
            <button class="btn btn-primary" onclick="joinGame()">ì ‘ì†í•˜ê¸°</button>
            <div class="status-message" id="guest-status"></div>
        </div>
    </div>

    <div id="game-screen">
        <div class="scoreboard">
            <div class="player-score" id="player1-score">
                <h3 id="player1-name">í”Œë ˆì´ì–´ 1</h3>
                <div class="score-value">ğŸŸ¡ <span id="p1-score">0</span></div>
                <div>ğŸ† <span id="p1-seals">0</span></div>
            </div>
            <div class="player-score" id="player2-score">
                <h3 id="player2-name">í”Œë ˆì´ì–´ 2</h3>
                <div class="score-value">ğŸŸ¡ <span id="p2-score">0</span></div>
                <div>ğŸ† <span id="p2-seals">0</span></div>
            </div>
        </div>
        <div class="game-info">
            <div><strong>ë± ë‚¨ì€ ì¹´ë“œ:</strong> <span id="deck-count">40</span>ì¥</div>
            <div class="token-display">
                <div class="token-item">ğŸ’ <span id="token-diamond">5</span></div>
                <div class="token-item">ğŸ’° <span id="token-gold">5</span></div>
                <div class="token-item">ğŸ¥ˆ <span id="token-silver">5</span></div>
                <div class="token-item">ğŸ§¶ <span id="token-cloth">7</span></div>
                <div class="token-item">ğŸŒ¶ï¸ <span id="token-spice">7</span></div>
                <div class="token-item">ğŸ‘œ <span id="token-leather">7</span></div>
            </div>
        </div>
        <div class="game-board">
            <div class="opponent-area">
                <div class="area-title">ğŸ© ìƒëŒ€ ì†íŒ¨</div>
                <div class="card-container" id="opponent-hand"></div>
            </div>
            <div class="market-area">
                <div class="area-title">ğŸª ì‹œì¥</div>
                <div class="card-container" id="market"></div>
            </div>
            <div class="player-area">
                <div class="area-title">âœ‹ ë‚´ ì†íŒ¨</div>
                <div class="card-container" id="my-hand"></div>
            </div>
            <div class="action-buttons">
                <button class="action-btn take" onclick="takeCard()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="action-btn exchange" onclick="exchangeCards()">ğŸ”„ êµí™˜í•˜ê¸°</button>
                <button class="action-btn sell" onclick="openSellModal()">ğŸ’° íŒë§¤í•˜ê¸°</button>
                <button class="action-btn koala-rush" onclick="koalaRush()">ğŸ¨ ì½”ì•Œë¼ ëª°ì´</button>
                <button class="action-btn end-turn" onclick="endTurn()">âœ… í„´ ì¢…ë£Œ</button>
            </div>
        </div>
    </div>

    <div id="sell-modal" class="modal">
        <div class="modal-content">
            <h2>ğŸ’° íŒë§¤í•  ìƒí’ˆ ì„ íƒ</h2>
            <div id="sell-options"></div>
            <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="closeSellModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // ê³µí†µ ì„¤ì • ë° ìƒìˆ˜
        const CARD_EMOJI = { koala: 'ğŸ¨', diamond: 'ğŸ’', gold: 'ğŸ’°', silver: 'ğŸ¥ˆ', cloth: 'ğŸ§¶', spice: 'ğŸŒ¶ï¸', leather: 'ğŸ‘œ' };
        const INITIAL_TOKENS = { diamond: 5, gold: 5, silver: 5, cloth: 7, spice: 7, leather: 7 };
        const TOKEN_VALUES = {
            diamond: [7, 7, 5, 5, 5], gold: [6, 6, 5, 5, 5], silver: [5, 5, 5, 5, 5],
            cloth: [5, 3, 3, 2, 2, 1, 1], spice: [5, 3, 3, 2, 2, 1, 1], leather: [4, 3, 2, 1, 1, 1, 1]
        };
        const BONUS_POINTS = { 3: 1, 4: 4, 5: 8, 6: 12, 7: 16 };

        // PeerJS ì„¤ì • (ëª¨ë°”ì¼ ì—°ê²° ì„±ê³µë¥ ì„ ë†’ì´ê¸° ìœ„í•´ STUN ì„œë²„ ì¶”ê°€)
        const PEER_CONFIG = {
            config: {
                'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'stun:stun1.l.google.com:19302' }
                ]
            },
            debug: 1
        };

        let peer = null, connection = null, isHost = false, myPlayerId = null;
        let gameState = {
            deck: [], market: [], player1Hand: [], player2Hand: [],
            player1Score: 0, player2Score: 0, player1Seals: 0, player2Seals: 0,
            tokens: JSON.parse(JSON.stringify(INITIAL_TOKENS)),
            currentTurn: 1, selectedCards: { myHand: [], market: [] },
            actionTaken: false, gameOver: false
        };

        // ì—°ê²° í•¨ìˆ˜
        function createGame() {
            peer = new Peer(PEER_CONFIG);
            isHost = true; myPlayerId = 1;
            peer.on('open', (id) => {
                document.getElementById('my-peer-id').textContent = id;
                document.getElementById('host-info').classList.add('active');
                showStatus('host-status', 'ìƒëŒ€ë°©ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', 'info');
            });
            peer.on('connection', (conn) => {
                connection = conn;
                setupConnection();
                showStatus('host-status', 'âœ… ì—°ê²°ë¨! ì‹œì‘ ì¤‘...', 'success');
                setTimeout(() => { initializeGame(); startGame(); }, 1000);
            });
            peer.on('error', (err) => showStatus('host-status', `âŒ ì˜¤ë¥˜: ${err.type}`, 'error'));
        }

        function showJoinForm() { document.getElementById('guest-form').classList.add('active'); }

        function joinGame() {
            const hostId = document.getElementById('peer-id-input').value.trim();
            if (!hostId) return showStatus('guest-status', 'IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
            peer = new Peer(PEER_CONFIG);
            isHost = false; myPlayerId = 2;
            peer.on('open', () => {
                connection = peer.connect(hostId, { reliable: true });
                setupConnection();
                showStatus('guest-status', 'Hostì— ì—°ê²° ì¤‘...', 'info');
            });
            peer.on('error', (err) => showStatus('guest-status', `âŒ ì˜¤ë¥˜: ${err.type}`, 'error'));
        }

        function setupConnection() {
            connection.on('open', () => console.log("P2P Open"));
            connection.on('data', (data) => {
                if (data.type === 'gameState') {
                    gameState = data.state;
                    if (!document.getElementById('game-screen').classList.contains('active')) {
                        startGame();
                    }
                    renderGame();
                } else if (data.type === 'action' && isHost) {
                    handleGuestAction(data.action);
                }
            });
            connection.on('close', () => { alert('ì—°ê²° ì¢…ë£Œ'); location.reload(); });
        }

        // ê²Œì„ ë¡œì§
        function initializeGame() {
            if (!isHost) return;
            gameState.deck = createDeck();
            shuffleDeck(gameState.deck);
            gameState.player1Hand = gameState.deck.splice(0, 5);
            gameState.player2Hand = gameState.deck.splice(0, 5);
            gameState.market = ['koala', 'koala', 'koala', ...gameState.deck.splice(0, 2)];
            gameState.tokens = JSON.parse(JSON.stringify(INITIAL_TOKENS));
            gameState.player1Score = gameState.player2Score = 0;
            gameState.currentTurn = 1;
            gameState.actionTaken = false;
            gameState.gameOver = false;
        }

        function createDeck() {
            const d = [];
            const goods = [{t:'diamond',c:6},{t:'gold',c:6},{t:'silver',c:6},{t:'cloth',c:8},{t:'spice',c:8},{t:'leather',c:10}];
            goods.forEach(g => { for(let i=0;i<g.c;i++) d.push(g.t); });
            for(let i=0;i<11;i++) d.push('koala');
            return d;
        }

        function shuffleDeck(d) { for(let i=d.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [d[i],d[j]]=[d[j],d[i]]; } }

        function startGame() {
            document.getElementById('connection-screen').style.display = 'none';
            document.getElementById('game-screen').classList.add('active');
            document.getElementById('player1-name').textContent = isHost ? 'ë‚˜ (P1)' : 'ìƒëŒ€ (P1)';
            document.getElementById('player2-name').textContent = isHost ? 'ìƒëŒ€ (P2)' : 'ë‚˜ (P2)';
            if(isHost) sendGameState();
        }

        function renderGame() {
            document.getElementById('p1-score').textContent = gameState.player1Score;
            document.getElementById('p2-score').textContent = gameState.player2Score;
            document.getElementById('p1-seals').textContent = gameState.player1Seals;
            document.getElementById('p2-seals').textContent = gameState.player2Seals;
            document.getElementById('deck-count').textContent = gameState.deck.length;

            Object.keys(INITIAL_TOKENS).forEach(k => {
                const el = document.getElementById(`token-${k}`);
                if(el) el.textContent = gameState.tokens[k];
            });

            const p1 = document.getElementById('player1-score'), p2 = document.getElementById('player2-score');
            gameState.currentTurn === 1 ? (p1.classList.add('current-turn'), p2.classList.remove('current-turn')) : (p2.classList.add('current-turn'), p1.classList.remove('current-turn'));

            renderContainer('my-hand', myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand, 'hand');
            renderContainer('market', gameState.market, 'market');
            renderOpponentHand();
            updateButtonStates();
            if (gameState.gameOver) showGameOver();
        }

        function renderContainer(id, cards, loc) {
            const el = document.getElementById(id); el.innerHTML = '';
            cards.forEach((c, i) => {
                const card = document.createElement('div');
                card.className = `card ${gameState.selectedCards[loc==='hand'?'myHand':'market'].includes(i)?'selected':''} ${gameState.currentTurn!==myPlayerId?'disabled':''}`;
                card.textContent = CARD_EMOJI[c];
                card.onclick = () => toggleSelect(i, loc);
                el.appendChild(card);
            });
        }

        function renderOpponentHand() {
            const el = document.getElementById('opponent-hand'); el.innerHTML = '';
            const count = myPlayerId === 1 ? gameState.player2Hand.length : gameState.player1Hand.length;
            for(let i=0;i<count;i++) { const c = document.createElement('div'); c.className='card back'; c.textContent='ğŸ´'; el.appendChild(c); }
        }

        function toggleSelect(i, loc) {
            if(gameState.currentTurn !== myPlayerId || gameState.actionTaken) return;
            const arr = gameState.selectedCards[loc==='hand'?'myHand':'market'];
            const p = arr.indexOf(i);
            p > -1 ? arr.splice(p, 1) : arr.push(i);
            renderGame();
        }

        function updateButtonStates() {
            const btns = document.querySelectorAll('.action-btn');
            btns.forEach(b => b.disabled = (gameState.currentTurn !== myPlayerId || gameState.gameOver));
        }

        // ì•¡ì…˜ë“¤
        function takeCard() {
            if(gameState.selectedCards.market.length !== 1) return alert('ì‹œì¥ ì¹´ë“œ 1ì¥ì„ ì„ íƒí•˜ì„¸ìš”.');
            const myHand = myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand;
            if(myHand.length >= 7) return alert('ì†íŒ¨ëŠ” ìµœëŒ€ 7ì¥ì…ë‹ˆë‹¤.');
            const action = { type: 'take', marketIndex: gameState.selectedCards.market[0] };
            isHost ? executeTake(action) : sendAction(action);
        }

        function executeTake(a) {
            const hand = gameState.currentTurn === 1 ? gameState.player1Hand : gameState.player2Hand;
            hand.push(gameState.market[a.marketIndex]);
            gameState.deck.length > 0 ? gameState.market[a.marketIndex] = gameState.deck.shift() : gameState.market.splice(a.marketIndex, 1);
            finishAction();
        }

        function exchangeCards() {
            const hCount = gameState.selectedCards.myHand.length, mCount = gameState.selectedCards.market.length;
            if(hCount < 2 || hCount !== mCount) return alert('2ì¥ ì´ìƒì˜ ê°™ì€ ê°œìˆ˜ ì¹´ë“œë¥¼ êµí™˜í•˜ì„¸ìš”.');
            const action = { type: 'exchange', hIdx: [...gameState.selectedCards.myHand].sort((a,b)=>b-a), mIdx: [...gameState.selectedCards.market].sort((a,b)=>b-a) };
            isHost ? executeExchange(action) : sendAction(action);
        }

        function executeExchange(a) {
            const hand = gameState.currentTurn === 1 ? gameState.player1Hand : gameState.player2Hand;
            const fromH = a.hIdx.map(i => hand.splice(i, 1)[0]);
            const fromM = a.mIdx.map(i => gameState.market[i]);
            a.mIdx.forEach((idx, i) => { gameState.market[idx] = fromH[i]; hand.push(fromM[i]); });
            finishAction();
        }

        function sellGoods(option) {
            closeSellModal();
            const action = { type: 'sell', good: option.type, count: option.count };
            isHost ? executeSell(action) : sendAction(action);
        }

        function executeSell(a) {
            const hand = gameState.currentTurn === 1 ? gameState.player1Hand : gameState.player2Hand;
            let removed = 0;
            for(let i=hand.length-1; i>=0 && removed<a.count; i--) { if(hand[i]===a.good) { hand.splice(i,1); removed++; } }
            const scoreKey = gameState.currentTurn === 1 ? 'player1Score' : 'player2Score';
            gameState[scoreKey] += calculatePoints(a.good, a.count);
            checkGameOver(); finishAction();
        }

        function koalaRush() {
            const kCount = gameState.market.filter(c => c === 'koala').length;
            if(kCount === 0) return alert('ì‹œì¥ì— ì½”ì•Œë¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            const action = { type: 'koalaRush' };
            isHost ? executeKoalaRush(action) : sendAction(action);
        }

        function executeKoalaRush(a) {
            const hand = gameState.currentTurn === 1 ? gameState.player1Hand : gameState.player2Hand;
            for(let i=gameState.market.length-1; i>=0; i--) {
                if(gameState.market[i] === 'koala') {
                    hand.push('koala');
                    gameState.deck.length > 0 ? gameState.market[i] = gameState.deck.shift() : gameState.market.splice(i, 1);
                }
            }
            finishAction();
        }

        function endTurn() {
            if(!gameState.actionTaken) return alert('ì•¡ì…˜ì„ ë¨¼ì € í•˜ì„¸ìš”.');
            const action = { type: 'endTurn' };
            isHost ? executeEndTurn(action) : sendAction(action);
        }

        function executeEndTurn() {
            gameState.currentTurn = gameState.currentTurn === 1 ? 2 : 1;
            gameState.actionTaken = false;
            gameState.selectedCards = { myHand: [], market: [] };
            if(isHost) sendGameState();
        }

        // ë³´ì¡° í•¨ìˆ˜
        function calculatePoints(type, count) {
            let p = 0; const tokens = TOKEN_VALUES[type];
            for(let i=0; i<count; i++) {
                if(gameState.tokens[type] > 0) {
                    p += tokens[tokens.length - gameState.tokens[type]];
                    gameState.tokens[type]--;
                }
            }
            if(BONUS_POINTS[count]) p += BONUS_POINTS[count];
            return p;
        }

        function finishAction() { gameState.actionTaken = true; gameState.selectedCards = { myHand:[], market:[] }; if(isHost) sendGameState(); renderGame(); }
        function sendGameState() { if(connection) connection.send({ type: 'gameState', state: gameState }); }
        function sendAction(a) { if(connection) connection.send({ type: 'action', action: a }); }
        function handleGuestAction(a) {
            if(a.type==='take') executeTake(a); else if(a.type==='exchange') executeExchange(a);
            else if(a.type==='sell') executeSell(a); else if(a.type==='koalaRush') executeKoalaRush(a);
            else if(a.type==='endTurn') executeEndTurn();
        }
        function checkGameOver() {
            const empty = Object.values(gameState.tokens).filter(v => v === 0).length;
            if(empty >= 3 || gameState.deck.length === 0) gameState.gameOver = true;
        }

        function showStatus(id, msg, type) { const el = document.getElementById(id); el.textContent = msg; el.className = `status-message ${type}`; }

        function openSellModal() {
            if(gameState.actionTaken) return;
            const hand = myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand;
            const counts = {}; hand.forEach(c => { if(c!=='koala') counts[c] = (counts[c]||0)+1; });
            const options = [];
            Object.entries(counts).forEach(([type, count]) => {
                const min = ['diamond','gold','silver'].includes(type) ? 2 : 1;
                if(count >= min) options.push({ type, count, emoji: CARD_EMOJI[type] });
            });
            if(options.length === 0) return alert('íŒë§¤í•  ìˆ˜ ìˆëŠ” ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.');
            const el = document.getElementById('sell-options'); el.innerHTML = '';
            options.forEach(o => {
                const div = document.createElement('div'); div.className = 'sell-option';
                div.innerHTML = `<span>${o.emoji} ${o.count}ì¥</span><span>íŒë§¤</span>`;
                div.onclick = () => sellGoods(o); el.appendChild(div);
            });
            document.getElementById('sell-modal').classList.add('active');
        }
        function closeSellModal() { document.getElementById('sell-modal').classList.remove('active'); }

        function showGameOver() {
            if(document.querySelector('.game-over')) return;
            let winner = gameState.player1Score > gameState.player2Score ? "P1" : "P2";
            if(gameState.player1Score === gameState.player2Score) winner = "ë¬´ìŠ¹ë¶€";
            const div = document.createElement('div'); div.className = 'game-over';
            div.innerHTML = `<h2>ğŸ‰ ê²Œì„ ì¢…ë£Œ!</h2><p>ìŠ¹ì: ${winner}</p><button class='btn btn-primary' onclick='location.reload()'>ì¬ê²½ê¸°</button>`;
            document.querySelector('.game-board').appendChild(div);
        }
    </script>
</body>
</html>
