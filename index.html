<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¨ Newsboy Koala Trader - P2P Card Game</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* =========================
           ì „ì—­ ìŠ¤íƒ€ì¼ ë° ê¸°ë³¸ ì„¤ì •
           ========================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        /* =========================
           í—¤ë” ì˜ì—­ (ì‹ ë¬¸ì‚¬ ì»¨ì…‰)
           ========================= */
        header {
            background: #fff;
            width: 100%;
            max-width: 1200px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        /* =========================
           ì—°ê²° í™”ë©´ (P2P ì„¤ì •)
           ========================= */
        #connection-screen {
            background: #fff;
            width: 100%;
            max-width: 600px;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        #connection-screen h2 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .connection-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .connection-info {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            display: none;
        }

        .connection-info.active {
            display: block;
        }

        .peer-id-display {
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
            margin: 10px 0;
            word-break: break-all;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }

        /* =========================
           ê²Œì„ í™”ë©´ ë©”ì¸ ë ˆì´ì•„ì›ƒ
           ========================= */
        #game-screen {
            display: none;
            width: 100%;
            max-width: 1200px;
        }

        #game-screen.active {
            display: block;
        }

        /* =========================
           ì ìˆ˜íŒ ë° ê²Œì„ ì •ë³´
           ========================= */
        .scoreboard {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .player-score {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .player-score.current-turn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .player-score h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .score-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .game-info {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .token-display {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .token-item {
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 1.2em;
        }

        /* =========================
           ê²Œì„íŒ ë ˆì´ì•„ì›ƒ
           ========================= */
        .game-board {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .opponent-area,
        .market-area,
        .player-area {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .area-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        .card-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            min-height: 80px;
        }

        /* =========================
           ì¹´ë“œ ìŠ¤íƒ€ì¼
           ========================= */
        .card {
            width: 70px;
            height: 100px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #dee2e6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: translateY(-10px) scale(1.1);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.5);
        }

        .card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .card.disabled:hover {
            transform: none;
        }

        /* ì¹´ë“œ ë’·ë©´ (ìƒëŒ€ ì†íŒ¨) */
        .card.back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1em;
        }

        /* =========================
           ì•¡ì…˜ ë²„íŠ¼
           ========================= */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .action-btn.take {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .action-btn.exchange {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .action-btn.sell {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .action-btn.koala-rush {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #333;
        }

        .action-btn.end-turn {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* =========================
           ëª¨ë‹¬ (íŒë§¤ UI)
           ========================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .sell-option {
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sell-option:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .sell-option.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .close-modal {
            margin-top: 20px;
            width: 100%;
        }

        /* =========================
           ë°˜ì‘í˜• ë””ìì¸ (ëª¨ë°”ì¼)
           ========================= */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .scoreboard {
                grid-template-columns: 1fr;
            }

            .card {
                width: 60px;
                height: 85px;
                font-size: 2em;
            }

            .action-btn {
                padding: 12px 20px;
                font-size: 1em;
            }

            .btn {
                padding: 12px 20px;
                font-size: 1em;
            }

            #connection-screen {
                padding: 20px;
            }
        }

        /* =========================
           ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
           ========================= */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* =========================
           ê²Œì„ ì¢…ë£Œ í™”ë©´
           ========================= */
        .game-over {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin-top: 20px;
        }

        .game-over h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .game-over .winner {
            font-size: 3em;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <header>
        <h1>ğŸ¨ Newsboy Koala Trader</h1>
        <p>ğŸ“° ê¸°ìë“¤ì˜ íŠ¹ì¢… ê²½ìŸ! ìì´í‘¸ë¥´ ë£° ê¸°ë°˜ P2P ì¹´ë“œ ê²Œì„</p>
    </header>

    <!-- ì—°ê²° í™”ë©´ -->
    <div id="connection-screen">
        <h2>ğŸ”— ê²Œì„ ì—°ê²°</h2>
        <div class="connection-buttons">
            <button class="btn btn-primary" onclick="createGame()">ğŸ® ê²Œì„ ë§Œë“¤ê¸° (Host)</button>
            <button class="btn btn-secondary" onclick="showJoinForm()">ğŸš€ ê²Œì„ ì°¸ê°€ (Guest)</button>
        </div>

        <!-- Host ì •ë³´ í‘œì‹œ -->
        <div id="host-info" class="connection-info">
            <p>ë‹¹ì‹ ì˜ ê²Œì„ ID:</p>
            <div class="peer-id-display" id="my-peer-id">ì—°ê²° ì¤‘...</div>
            <p>ìƒëŒ€ë°©ì´ ì´ IDë¡œ ì ‘ì†í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            <div class="status-message" id="host-status"></div>
        </div>

        <!-- Guest ì…ë ¥ í¼ -->
        <div id="guest-form" class="connection-info">
            <p>Hostì˜ ê²Œì„ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:</p>
            <input type="text" id="peer-id-input" placeholder="Host ID ì…ë ¥">
            <button class="btn btn-primary" onclick="joinGame()">ì ‘ì†í•˜ê¸°</button>
            <div class="status-message" id="guest-status"></div>
        </div>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="game-screen">
        <!-- ì ìˆ˜íŒ -->
        <div class="scoreboard">
            <div class="player-score" id="player1-score">
                <h3 id="player1-name">í”Œë ˆì´ì–´ 1</h3>
                <div class="score-value">ğŸŸ¡ <span id="p1-score">0</span></div>
                <div>ğŸ† <span id="p1-seals">0</span></div>
            </div>
            <div class="player-score" id="player2-score">
                <h3 id="player2-name">í”Œë ˆì´ì–´ 2</h3>
                <div class="score-value">ğŸŸ¡ <span id="p2-score">0</span></div>
                <div>ğŸ† <span id="p2-seals">0</span></div>
            </div>
        </div>

        <!-- ê²Œì„ ì •ë³´ -->
        <div class="game-info">
            <div><strong>ë± ë‚¨ì€ ì¹´ë“œ:</strong> <span id="deck-count">40</span>ì¥</div>
            <div class="token-display">
                <div class="token-item">ğŸ’ <span id="token-diamond">5</span></div>
                <div class="token-item">ğŸ’° <span id="token-gold">5</span></div>
                <div class="token-item">ğŸ¥ˆ <span id="token-silver">5</span></div>
                <div class="token-item">ğŸ§¶ <span id="token-cloth">7</span></div>
                <div class="token-item">ğŸŒ¶ï¸ <span id="token-spice">7</span></div>
                <div class="token-item">ğŸ‘œ <span id="token-leather">7</span></div>
            </div>
        </div>

        <!-- ê²Œì„íŒ -->
        <div class="game-board">
            <!-- ìƒëŒ€ ì˜ì—­ -->
            <div class="opponent-area">
                <div class="area-title">ğŸ© ìƒëŒ€ ì†íŒ¨</div>
                <div class="card-container" id="opponent-hand"></div>
            </div>

            <!-- ì‹œì¥ -->
            <div class="market-area">
                <div class="area-title">ğŸª ì‹œì¥</div>
                <div class="card-container" id="market"></div>
            </div>

            <!-- ë‚´ ì˜ì—­ -->
            <div class="player-area">
                <div class="area-title">âœ‹ ë‚´ ì†íŒ¨</div>
                <div class="card-container" id="my-hand"></div>
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="action-buttons">
                <button class="action-btn take" onclick="takeCard()">ğŸ“¥ ê°€ì ¸ì˜¤ê¸°</button>
                <button class="action-btn exchange" onclick="exchangeCards()">ğŸ”„ êµí™˜í•˜ê¸°</button>
                <button class="action-btn sell" onclick="openSellModal()">ğŸ’° íŒë§¤í•˜ê¸°</button>
                <button class="action-btn koala-rush" onclick="koalaRush()">ğŸ¨ ì½”ì•Œë¼ ëª°ì´</button>
                <button class="action-btn end-turn" onclick="endTurn()">âœ… í„´ ì¢…ë£Œ</button>
            </div>
        </div>
    </div>

    <!-- íŒë§¤ ëª¨ë‹¬ -->
    <div id="sell-modal" class="modal">
        <div class="modal-content">
            <h2>ğŸ’° íŒë§¤í•  ìƒí’ˆ ì„ íƒ</h2>
            <div id="sell-options"></div>
            <button class="btn btn-primary close-modal" onclick="closeSellModal()">ì·¨ì†Œ</button>
        </div>
    </div>

    <script>
        // =============================================
        // ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜ ì •ì˜
        // =============================================

        /**
         * ì¹´ë“œ íƒ€ì…ë³„ ì´ëª¨ì§€ ë§¤í•‘
         * - koala: íŠ¹ìˆ˜ êµí™˜ ì¹´ë“œ
         * - diamond, gold, silver: ê³ ê°€ ìƒí’ˆ (2ì¥ ì´ìƒ íŒë§¤ í•„ìš”)
         * - cloth, spice, leather: ì¼ë°˜ ìƒí’ˆ (1ì¥ë¶€í„° íŒë§¤ ê°€ëŠ¥)
         */
        const CARD_EMOJI = {
            koala: 'ğŸ¨',
            diamond: 'ğŸ’',
            gold: 'ğŸ’°',
            silver: 'ğŸ¥ˆ',
            cloth: 'ğŸ§¶',
            spice: 'ğŸŒ¶ï¸',
            leather: 'ğŸ‘œ'
        };

        /**
         * ìƒí’ˆë³„ í† í° ê°œìˆ˜ (ê²Œì„ ì‹œì‘ ì‹œ ê° ìƒí’ˆì˜ í† í° ìˆ˜)
         */
        const INITIAL_TOKENS = {
            diamond: 5,
            gold: 5,
            silver: 5,
            cloth: 7,
            spice: 7,
            leather: 7
        };

        /**
         * ìƒí’ˆë³„ í† í° ì ìˆ˜ ë¶„í¬
         * - ê³ ê°€ ìƒí’ˆì¼ìˆ˜ë¡ ë†’ì€ ì ìˆ˜ í† í°ì´ ë§ìŒ
         * - ë°°ì—´ ìˆœì„œëŒ€ë¡œ í† í°ì´ ë¶„ë°°ë¨ (ì²« íŒë§¤ìê°€ ë†’ì€ ì ìˆ˜ íšë“)
         */
        const TOKEN_VALUES = {
            diamond: [7, 7, 5, 5, 5],
            gold: [6, 6, 5, 5, 5],
            silver: [5, 5, 5, 5, 5],
            cloth: [5, 3, 3, 2, 2, 1, 1],
            spice: [5, 3, 3, 2, 2, 1, 1],
            leather: [4, 3, 2, 1, 1, 1, 1]
        };

        /**
         * ë³´ë„ˆìŠ¤ ì ìˆ˜ (í•œ ë²ˆì— ì—¬ëŸ¬ ì¥ íŒë§¤ ì‹œ ì¶”ê°€ ì ìˆ˜)
         * - 3ì¥: 1ì , 4ì¥: 4ì , 5ì¥: 8ì , 6ì¥: 12ì , 7ì¥: 16ì 
         */
        const BONUS_POINTS = {
            3: 1,
            4: 4,
            5: 8,
            6: 12,
            7: 16
        };

        // PeerJS ê´€ë ¨ ë³€ìˆ˜
        let peer = null;              // PeerJS ì¸ìŠ¤í„´ìŠ¤
        let connection = null;        // í˜„ì¬ P2P ì—°ê²°
        let isHost = false;           // Host ì—¬ë¶€ (true: Host, false: Guest)
        let myPlayerId = null;        // ë‚´ í”Œë ˆì´ì–´ ë²ˆí˜¸ (1 ë˜ëŠ” 2)

        // ê²Œì„ ìƒíƒœ ê°ì²´ (Hostê°€ ë§ˆìŠ¤í„° ë°ì´í„° ë³´ìœ )
        let gameState = {
            deck: [],                 // ë± (ë‚¨ì€ ì¹´ë“œë“¤)
            market: [],               // ì‹œì¥ ì¹´ë“œ (5ì¥)
            player1Hand: [],          // í”Œë ˆì´ì–´ 1 ì†íŒ¨
            player2Hand: [],          // í”Œë ˆì´ì–´ 2 ì†íŒ¨
            player1Score: 0,          // í”Œë ˆì´ì–´ 1 ì ìˆ˜
            player2Score: 0,          // í”Œë ˆì´ì–´ 2 ì ìˆ˜
            player1Seals: 0,          // í”Œë ˆì´ì–´ 1 ì¸ì¥ ìˆ˜
            player2Seals: 0,          // í”Œë ˆì´ì–´ 2 ì¸ì¥ ìˆ˜
            tokens: JSON.parse(JSON.stringify(INITIAL_TOKENS)), // ë‚¨ì€ í† í°
            currentTurn: 1,           // í˜„ì¬ í„´ í”Œë ˆì´ì–´ (1 ë˜ëŠ” 2)
            selectedCards: {          // ì„ íƒëœ ì¹´ë“œ (UI ìƒíƒœ)
                myHand: [],
                market: []
            },
            actionTaken: false,       // ì´ë²ˆ í„´ì— ì•¡ì…˜ì„ í–ˆëŠ”ì§€ ì—¬ë¶€
            gameOver: false           // ê²Œì„ ì¢…ë£Œ ì—¬ë¶€
        };

        // =============================================
        // P2P ì—°ê²° ê´€ë¦¬ í•¨ìˆ˜
        // =============================================

        /**
         * ê²Œì„ ë§Œë“¤ê¸° (Host)
         * - PeerJS ì„œë²„ì— ì—°ê²°í•˜ê³  ê³ ìœ  ID ìƒì„±
         * - Guestì˜ ì ‘ì†ì„ ê¸°ë‹¤ë¦¼
         */
        function createGame() {
            // PeerJS ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (ìë™ ID ìƒì„±)
            peer = new Peer();
            isHost = true;
            myPlayerId = 1;

            // PeerJS ì„œë²„ ì—°ê²° ì„±ê³µ ì‹œ
            peer.on('open', (id) => {
                console.log('Host Peer ID:', id);
                document.getElementById('my-peer-id').textContent = id;
                document.getElementById('host-info').classList.add('active');
                showStatus('host-status', 'ìƒëŒ€ë°©ì˜ ì ‘ì†ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', 'info');
            });

            // Guestê°€ ì—°ê²° ì‹œë„í•  ë•Œ
            peer.on('connection', (conn) => {
                connection = conn;
                setupConnection();
                showStatus('host-status', 'âœ… ìƒëŒ€ë°©ì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                
                // ê²Œì„ ì´ˆê¸°í™” ë° ì‹œì‘
                setTimeout(() => {
                    initializeGame();
                    startGame();
                }, 1000);
            });

            // ì—ëŸ¬ ì²˜ë¦¬
            peer.on('error', (err) => {
                console.error('Peer Error:', err);
                showStatus('host-status', `âŒ ì—°ê²° ì˜¤ë¥˜: ${err.type}`, 'error');
            });
        }

        /**
         * ê²Œì„ ì°¸ê°€ í¼ í‘œì‹œ (Guest)
         */
        function showJoinForm() {
            document.getElementById('guest-form').classList.add('active');
        }

        /**
         * ê²Œì„ ì°¸ê°€í•˜ê¸° (Guest)
         * - Hostì˜ IDë¡œ ì—°ê²° ì‹œë„
         */
        function joinGame() {
            const hostId = document.getElementById('peer-id-input').value.trim();
            
            if (!hostId) {
                showStatus('guest-status', 'âŒ Host IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // PeerJS ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
            peer = new Peer();
            isHost = false;
            myPlayerId = 2;

            // PeerJS ì„œë²„ ì—°ê²° ì„±ê³µ ì‹œ
            peer.on('open', (id) => {
                console.log('Guest Peer ID:', id);
                showStatus('guest-status', 'ì—°ê²° ì¤‘...', 'info');

                // Hostì—ê²Œ ì—°ê²° ì‹œë„
                connection = peer.connect(hostId, {
                    reliable: true
                });

                setupConnection();
            });

            // ì—ëŸ¬ ì²˜ë¦¬
            peer.on('error', (err) => {
                console.error('Peer Error:', err);
                showStatus('guest-status', `âŒ ì—°ê²° ì˜¤ë¥˜: ${err.type}. Host IDë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'error');
            });
        }

        /**
         * P2P ì—°ê²° ì„¤ì •
         * - ì—°ê²° ì„±ê³µ/ì‹¤íŒ¨ ì´ë²¤íŠ¸ ì²˜ë¦¬
         * - ë°ì´í„° ìˆ˜ì‹  ì´ë²¤íŠ¸ ì²˜ë¦¬
         */
        function setupConnection() {
            // ì—°ê²° ì„±ê³µ ì‹œ
            connection.on('open', () => {
                console.log('Connection established!');
                if (!isHost) {
                    showStatus('guest-status', 'âœ… ì—°ê²° ì„±ê³µ! ê²Œì„ ì‹œì‘ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...', 'success');
                }
            });

            // ë°ì´í„° ìˆ˜ì‹  ì‹œ
            connection.on('data', (data) => {
                handleReceivedData(data);
            });

            // ì—°ê²° ì¢…ë£Œ ì‹œ
            connection.on('close', () => {
                alert('âŒ ìƒëŒ€ë°©ê³¼ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
                location.reload();
            });

            // ì—ëŸ¬ ë°œìƒ ì‹œ
            connection.on('error', (err) => {
                console.error('Connection Error:', err);
                alert(`âŒ ì—°ê²° ì˜¤ë¥˜: ${err}`);
            });
        }

        /**
         * ìˆ˜ì‹ ëœ ë°ì´í„° ì²˜ë¦¬
         * @param {Object} data - ìˆ˜ì‹ ëœ ë°ì´í„° ê°ì²´
         */
        function handleReceivedData(data) {
            console.log('Received data:', data);

            // ë°ì´í„° íƒ€ì…ë³„ ì²˜ë¦¬
            switch(data.type) {
                case 'gameState':
                    // ì „ì²´ ê²Œì„ ìƒíƒœ ë™ê¸°í™”
                    gameState = data.state;
                    renderGame();
                    break;
                case 'action':
                    // Guestì˜ ì•¡ì…˜ì„ Hostê°€ ì²˜ë¦¬
                    if (isHost) {
                        handleGuestAction(data.action);
                    }
                    break;
            }
        }

        /**
         * ê²Œì„ ìƒíƒœ ì „ì†¡ (Host â†’ Guest)
         */
        function sendGameState() {
            if (connection && connection.open) {
                connection.send({
                    type: 'gameState',
                    state: gameState
                });
            }
        }

        /**
         * ì•¡ì…˜ ì „ì†¡ (Guest â†’ Host)
         * @param {Object} action - ì•¡ì…˜ ê°ì²´
         */
        function sendAction(action) {
            if (connection && connection.open) {
                connection.send({
                    type: 'action',
                    action: action
                });
            }
        }

        /**
         * ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
         * @param {string} elementId - ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ìš”ì†Œ ID
         * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
         * @param {string} type - ë©”ì‹œì§€ íƒ€ì… (success, error, info)
         */
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
        }

        // =============================================
        // ê²Œì„ ì´ˆê¸°í™” ë° ì‹œì‘
        // =============================================

        /**
         * ê²Œì„ ì´ˆê¸°í™” (Hostë§Œ ì‹¤í–‰)
         * - ë± ìƒì„± ë° ì…”í”Œ
         * - ì´ˆê¸° ì¹´ë“œ ë¶„ë°°
         * - ì‹œì¥ ì„¤ì •
         */
        function initializeGame() {
            if (!isHost) return;

            console.log('Initializing game...');

            // ë± ìƒì„±
            gameState.deck = createDeck();
            
            // ì…”í”Œ
            shuffleDeck(gameState.deck);

            // ì´ˆê¸° ì†íŒ¨ ë¶„ë°° (ê° í”Œë ˆì´ì–´ 5ì¥)
            gameState.player1Hand = gameState.deck.splice(0, 5);
            gameState.player2Hand = gameState.deck.splice(0, 5);

            // ì‹œì¥ ì„¤ì • (5ì¥, ì½”ì•Œë¼ 3ì¥ ë³´ì¥)
            gameState.market = ['koala', 'koala', 'koala'];
            
            // ë‚˜ë¨¸ì§€ 2ì¥ì€ ì¼ë°˜ ìƒí’ˆ ì¹´ë“œ
            let remainingCards = gameState.deck.filter(c => c !== 'koala');
            gameState.market.push(remainingCards[0], remainingCards[1]);
            gameState.deck = gameState.deck.filter(c => 
                c !== remainingCards[0] || gameState.deck.indexOf(c) !== gameState.deck.indexOf(remainingCards[0])
            ).filter(c => 
                c !== remainingCards[1] || gameState.deck.indexOf(c) !== gameState.deck.indexOf(remainingCards[1])
            );

            // í† í° ì´ˆê¸°í™”
            gameState.tokens = JSON.parse(JSON.stringify(INITIAL_TOKENS));

            // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            gameState.player1Score = 0;
            gameState.player2Score = 0;
            gameState.player1Seals = 0;
            gameState.player2Seals = 0;
            gameState.currentTurn = 1;
            gameState.actionTaken = false;
            gameState.gameOver = false;

            console.log('Game initialized:', gameState);
        }

        /**
         * ë± ìƒì„±
         * @returns {Array} ìƒì„±ëœ ë± ë°°ì—´
         */
        function createDeck() {
            const deck = [];

            // ìƒí’ˆ ì¹´ë“œ ì¶”ê°€
            const goods = [
                { type: 'diamond', count: 6 },
                { type: 'gold', count: 6 },
                { type: 'silver', count: 6 },
                { type: 'cloth', count: 8 },
                { type: 'spice', count: 8 },
                { type: 'leather', count: 10 }
            ];

            goods.forEach(good => {
                for (let i = 0; i < good.count; i++) {
                    deck.push(good.type);
                }
            });

            // ì½”ì•Œë¼ ì¹´ë“œ ì¶”ê°€ (11ì¥)
            for (let i = 0; i < 11; i++) {
                deck.push('koala');
            }

            return deck;
        }

        /**
         * ë± ì…”í”Œ (Fisher-Yates ì•Œê³ ë¦¬ì¦˜)
         * @param {Array} deck - ì…”í”Œí•  ë± ë°°ì—´
         */
        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        /**
         * ê²Œì„ ì‹œì‘
         * - ì—°ê²° í™”ë©´ ìˆ¨ê¸°ê³  ê²Œì„ í™”ë©´ í‘œì‹œ
         * - ê²Œì„ ë Œë”ë§
         */
        function startGame() {
            document.getElementById('connection-screen').style.display = 'none';
            document.getElementById('game-screen').classList.add('active');
            
            // í”Œë ˆì´ì–´ ì´ë¦„ ì„¤ì •
            document.getElementById('player1-name').textContent = isHost ? 'ë‚˜ (Host)' : 'ìƒëŒ€ (Host)';
            document.getElementById('player2-name').textContent = isHost ? 'ìƒëŒ€ (Guest)' : 'ë‚˜ (Guest)';

            renderGame();
            
            // Hostê°€ ê²Œì„ ìƒíƒœ ì „ì†¡
            if (isHost) {
                sendGameState();
            }
        }

        // =============================================
        // ê²Œì„ ë Œë”ë§
        // =============================================

        /**
         * ê²Œì„ í™”ë©´ ë Œë”ë§
         * - ëª¨ë“  ê²Œì„ ìš”ì†Œë¥¼ í˜„ì¬ gameStateì— ë§ì¶° í™”ë©´ì— ê·¸ë¦¼
         */
        function renderGame() {
            // ì ìˆ˜ ì—…ë°ì´íŠ¸
            document.getElementById('p1-score').textContent = gameState.player1Score;
            document.getElementById('p2-score').textContent = gameState.player2Score;
            document.getElementById('p1-seals').textContent = gameState.player1Seals;
            document.getElementById('p2-seals').textContent = gameState.player2Seals;

            // í˜„ì¬ í„´ í‘œì‹œ
            const p1ScoreEl = document.getElementById('player1-score');
            const p2ScoreEl = document.getElementById('player2-score');
            
            if (gameState.currentTurn === 1) {
                p1ScoreEl.classList.add('current-turn');
                p2ScoreEl.classList.remove('current-turn');
            } else {
                p1ScoreEl.classList.remove('current-turn');
                p2ScoreEl.classList.add('current-turn');
            }

            // ë± ë° í† í° ì •ë³´
            document.getElementById('deck-count').textContent = gameState.deck.length;
            document.getElementById('token-diamond').textContent = gameState.tokens.diamond;
            document.getElementById('token-gold').textContent = gameState.tokens.gold;
            document.getElementById('token-silver').textContent = gameState.tokens.silver;
            document.getElementById('token-cloth').textContent = gameState.tokens.cloth;
            document.getElementById('token-spice').textContent = gameState.tokens.spice;
            document.getElementById('token-leather').textContent = gameState.tokens.leather;

            // ì¹´ë“œ ë Œë”ë§
            renderHand();
            renderMarket();
            renderOpponentHand();

            // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            updateButtonStates();

            // ê²Œì„ ì¢…ë£Œ ì²´í¬
            if (gameState.gameOver) {
                showGameOver();
            }
        }

        /**
         * ë‚´ ì†íŒ¨ ë Œë”ë§
         */
        function renderHand() {
            const handEl = document.getElementById('my-hand');
            handEl.innerHTML = '';

            const myHand = myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand;

            myHand.forEach((card, index) => {
                const cardEl = createCardElement(card, index, 'hand');
                handEl.appendChild(cardEl);
            });
        }

        /**
         * ì‹œì¥ ë Œë”ë§
         */
        function renderMarket() {
            const marketEl = document.getElementById('market');
            marketEl.innerHTML = '';

            gameState.market.forEach((card, index) => {
                const cardEl = createCardElement(card, index, 'market');
                marketEl.appendChild(cardEl);
            });
        }

        /**
         * ìƒëŒ€ ì†íŒ¨ ë Œë”ë§ (ë’·ë©´ìœ¼ë¡œ í‘œì‹œ)
         */
        function renderOpponentHand() {
            const opponentEl = document.getElementById('opponent-hand');
            opponentEl.innerHTML = '';

            const opponentHand = myPlayerId === 1 ? gameState.player2Hand : gameState.player1Hand;

            opponentHand.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'card back';
                cardEl.textContent = 'ğŸ´';
                opponentEl.appendChild(cardEl);
            });
        }

        /**
         * ì¹´ë“œ ìš”ì†Œ ìƒì„±
         * @param {string} cardType - ì¹´ë“œ íƒ€ì…
         * @param {number} index - ì¹´ë“œ ì¸ë±ìŠ¤
         * @param {string} location - ì¹´ë“œ ìœ„ì¹˜ ('hand' ë˜ëŠ” 'market')
         * @returns {HTMLElement} ìƒì„±ëœ ì¹´ë“œ DOM ìš”ì†Œ
         */
        function createCardElement(cardType, index, location) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card';
            cardEl.textContent = CARD_EMOJI[cardType];
            cardEl.dataset.index = index;
            cardEl.dataset.location = location;

            // ë‚´ í„´ì¼ ë•Œë§Œ ì¹´ë“œ ì„ íƒ ê°€ëŠ¥
            if (isMyTurn()) {
                cardEl.onclick = () => toggleCardSelection(cardType, index, location);
            } else {
                cardEl.classList.add('disabled');
            }

            // ì„ íƒ ìƒíƒœ í‘œì‹œ
            if (gameState.selectedCards[location === 'hand' ? 'myHand' : 'market'].includes(index)) {
                cardEl.classList.add('selected');
            }

            return cardEl;
        }

        /**
         * ì¹´ë“œ ì„ íƒ/í•´ì œ í† ê¸€
         * @param {string} cardType - ì¹´ë“œ íƒ€ì…
         * @param {number} index - ì¹´ë“œ ì¸ë±ìŠ¤
         * @param {string} location - ì¹´ë“œ ìœ„ì¹˜
         */
        function toggleCardSelection(cardType, index, location) {
            if (!isMyTurn()) return;

            const selectedArray = location === 'hand' ? gameState.selectedCards.myHand : gameState.selectedCards.market;
            const indexPos = selectedArray.indexOf(index);

            if (indexPos > -1) {
                // ì´ë¯¸ ì„ íƒëœ ì¹´ë“œë©´ í•´ì œ
                selectedArray.splice(indexPos, 1);
            } else {
                // ì„ íƒ ì¶”ê°€
                selectedArray.push(index);
            }

            renderGame();
        }

        /**
         * ë‚´ í„´ì¸ì§€ í™•ì¸
         * @returns {boolean} ë‚´ í„´ ì—¬ë¶€
         */
        function isMyTurn() {
            return gameState.currentTurn === myPlayerId;
        }

        /**
         * ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì—…ë°ì´íŠ¸
         */
        function updateButtonStates() {
            const buttons = document.querySelectorAll('.action-btn');
            const isEnabled = isMyTurn() && !gameState.gameOver;

            buttons.forEach(btn => {
                btn.disabled = !isEnabled;
            });
        }

        // =============================================
        // ê²Œì„ ì•¡ì…˜ ì²˜ë¦¬
        // =============================================

        /**
         * ì¹´ë“œ ê°€ì ¸ì˜¤ê¸° (1ì¥)
         * - ì‹œì¥ì—ì„œ ì„ íƒí•œ ì¹´ë“œ 1ì¥ì„ ì†íŒ¨ë¡œ ê°€ì ¸ì˜´
         */
        function takeCard() {
            if (!isMyTurn() || gameState.actionTaken) {
                alert('ì§€ê¸ˆì€ ì•¡ì…˜ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (gameState.selectedCards.market.length !== 1) {
                alert('ì‹œì¥ ì¹´ë“œë¥¼ ì •í™•íˆ 1ì¥ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const myHand = myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand;
            
            if (myHand.length >= 7) {
                alert('ì†íŒ¨ê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! (ìµœëŒ€ 7ì¥)');
                return;
            }

            const action = {
                type: 'take',
                marketIndex: gameState.selectedCards.market[0]
            };

            if (isHost) {
                executeTakeCard(action);
            } else {
                sendAction(action);
            }
        }

        /**
         * ì¹´ë“œ ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰ (Host)
         * @param {Object} action - ì•¡ì…˜ ê°ì²´
         */
        function executeTakeCard(action) {
            const playerId = isHost ? (gameState.currentTurn === 1 ? 'player1Hand' : 'player2Hand') : 
                                      (gameState.currentTurn === 2 ? 'player2Hand' : 'player1Hand');
            const hand = gameState[playerId];

            // ì‹œì¥ì—ì„œ ì¹´ë“œ ê°€ì ¸ì˜¤ê¸°
            const card = gameState.market[action.marketIndex];
            hand.push(card);

            // ì‹œì¥ ë³´ì¶©
            if (gameState.deck.length > 0) {
                gameState.market[action.marketIndex] = gameState.deck.shift();
            } else {
                gameState.market.splice(action.marketIndex, 1);
            }

            // ì„ íƒ ì´ˆê¸°í™” ë° ì•¡ì…˜ ì™„ë£Œ í‘œì‹œ
            gameState.selectedCards = { myHand: [], market: [] };
            gameState.actionTaken = true;

            sendGameState();
            renderGame();
        }

        /**
         * ì¹´ë“œ êµí™˜í•˜ê¸°
         * - ë‚´ ì†íŒ¨ì™€ ì‹œì¥ ì¹´ë“œë¥¼ ë™ì‹œì— êµí™˜
         * - ê°™ì€ ê°œìˆ˜ë§Œí¼ êµí™˜ ê°€ëŠ¥
         */
        function exchangeCards() {
            if (!isMyTurn() || gameState.actionTaken) {
                alert('ì§€ê¸ˆì€ ì•¡ì…˜ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const myHandSelected = gameState.selectedCards.myHand.length;
            const marketSelected = gameState.selectedCards.market.length;

            if (myHandSelected === 0 || marketSelected === 0) {
                alert('ì†íŒ¨ì™€ ì‹œì¥ ì¹´ë“œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (myHandSelected < 2) {
                alert('ìµœì†Œ 2ì¥ ì´ìƒ êµí™˜í•´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const myHand = myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand;
            
            if (myHand.length - myHandSelected + marketSelected > 7) {
                alert('êµí™˜ í›„ ì†íŒ¨ê°€ 7ì¥ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const action = {
                type: 'exchange',
                handIndices: [...gameState.selectedCards.myHand].sort((a, b) => b - a),
                marketIndices: [...gameState.selectedCards.market].sort((a, b) => b - a)
            };

            if (isHost) {
                executeExchange(action);
            } else {
                sendAction(action);
            }
        }

        /**
         * ì¹´ë“œ êµí™˜ ì‹¤í–‰ (Host)
         * @param {Object} action - ì•¡ì…˜ ê°ì²´
         */
        function executeExchange(action) {
            const playerId = isHost ? (gameState.currentTurn === 1 ? 'player1Hand' : 'player2Hand') : 
                                      (gameState.currentTurn === 2 ? 'player2Hand' : 'player1Hand');
            const hand = gameState[playerId];

            // ì†íŒ¨ì—ì„œ ì œê±°í•  ì¹´ë“œ
            const removedFromHand = action.handIndices.map(i => hand[i]);
            action.handIndices.forEach(i => hand.splice(i, 1));

            // ì‹œì¥ì—ì„œ ê°€ì ¸ì˜¬ ì¹´ë“œ
            const takenFromMarket = action.marketIndices.map(i => gameState.market[i]);
            takenFromMarket.forEach(card => hand.push(card));

            // ì‹œì¥ì— ì†íŒ¨ ì¹´ë“œ ë°°ì¹˜
            action.marketIndices.forEach((marketIndex, i) => {
                gameState.market[marketIndex] = removedFromHand[i];
            });

            // ì„ íƒ ì´ˆê¸°í™” ë° ì•¡ì…˜ ì™„ë£Œ
            gameState.selectedCards = { myHand: [], market: [] };
            gameState.actionTaken = true;

            sendGameState();
            renderGame();
        }

        /**
         * íŒë§¤ ëª¨ë‹¬ ì—´ê¸°
         */
        function openSellModal() {
            if (!isMyTurn() || gameState.actionTaken) {
                alert('ì§€ê¸ˆì€ ì•¡ì…˜ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const myHand = myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand;

            // íŒë§¤ ê°€ëŠ¥í•œ ìƒí’ˆ ê·¸ë£¹ ì°¾ê¸°
            const goodsCounts = {};
            myHand.forEach(card => {
                if (card !== 'koala') {
                    goodsCounts[card] = (goodsCounts[card] || 0) + 1;
                }
            });

            const sellOptions = [];
            for (const [goodType, count] of Object.entries(goodsCounts)) {
                // ê³ ê°€ ìƒí’ˆì€ 2ì¥ ì´ìƒ, ì¼ë°˜ ìƒí’ˆì€ 1ì¥ ì´ìƒ
                const minCount = ['diamond', 'gold', 'silver'].includes(goodType) ? 2 : 1;
                
                if (count >= minCount) {
                    // íŒë§¤ ê°€ëŠ¥í•œ ëª¨ë“  ì¡°í•© ì¶”ê°€
                    for (let i = minCount; i <= count; i++) {
                        sellOptions.push({
                            type: goodType,
                            count: i,
                            emoji: CARD_EMOJI[goodType]
                        });
                    }
                }
            }

            if (sellOptions.length === 0) {
                alert('íŒë§¤í•  ìˆ˜ ìˆëŠ” ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.\n(ê³ ê°€ ìƒí’ˆì€ 2ì¥ ì´ìƒ í•„ìš”)');
                return;
            }

            // ëª¨ë‹¬ì— ì˜µì…˜ í‘œì‹œ
            const optionsEl = document.getElementById('sell-options');
            optionsEl.innerHTML = '';

            sellOptions.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'sell-option';
                optionEl.innerHTML = `
                    <span>${option.emoji} ${option.count}ì¥</span>
                    <span>ì˜ˆìƒ ì ìˆ˜: ${calculateSellPoints(option.type, option.count)}ì </span>
                `;
                optionEl.onclick = () => sellGoods(option);
                optionsEl.appendChild(optionEl);
            });

            document.getElementById('sell-modal').classList.add('active');
        }

        /**
         * íŒë§¤ ëª¨ë‹¬ ë‹«ê¸°
         */
        function closeSellModal() {
            document.getElementById('sell-modal').classList.remove('active');
        }

        /**
         * ìƒí’ˆ íŒë§¤í•˜ê¸°
         * @param {Object} option - íŒë§¤í•  ìƒí’ˆ ì •ë³´
         */
        function sellGoods(option) {
            closeSellModal();

            const action = {
                type: 'sell',
                goodType: option.type,
                count: option.count
            };

            if (isHost) {
                executeSell(action);
            } else {
                sendAction(action);
            }
        }

        /**
         * íŒë§¤ ì‹¤í–‰ (Host)
         * @param {Object} action - ì•¡ì…˜ ê°ì²´
         */
        function executeSell(action) {
            const playerId = isHost ? (gameState.currentTurn === 1 ? 'player1Hand' : 'player2Hand') : 
                                      (gameState.currentTurn === 2 ? 'player2Hand' : 'player1Hand');
            const hand = gameState[playerId];
            const scoreKey = playerId === 'player1Hand' ? 'player1Score' : 'player2Score';

            // ì†íŒ¨ì—ì„œ í•´ë‹¹ ìƒí’ˆ ì œê±°
            let removed = 0;
            for (let i = hand.length - 1; i >= 0 && removed < action.count; i--) {
                if (hand[i] === action.goodType) {
                    hand.splice(i, 1);
                    removed++;
                }
            }

            // ì ìˆ˜ ê³„ì‚°
            const points = calculateSellPoints(action.goodType, action.count);
            gameState[scoreKey] += points;

            // ì„ íƒ ì´ˆê¸°í™” ë° ì•¡ì…˜ ì™„ë£Œ
            gameState.selectedCards = { myHand: [], market: [] };
            gameState.actionTaken = true;

            // ê²Œì„ ì¢…ë£Œ ì²´í¬
            checkGameOver();

            sendGameState();
            renderGame();
        }

        /**
         * íŒë§¤ ì ìˆ˜ ê³„ì‚°
         * @param {string} goodType - ìƒí’ˆ íƒ€ì…
         * @param {number} count - íŒë§¤ ê°œìˆ˜
         * @returns {number} ì´ íšë“ ì ìˆ˜
         */
        function calculateSellPoints(goodType, count) {
            let points = 0;

            // í† í° ì ìˆ˜ í•©ì‚°
            const tokens = TOKEN_VALUES[goodType];
            const availableTokens = gameState.tokens[goodType];
            
            for (let i = 0; i < Math.min(count, availableTokens); i++) {
                points += tokens[tokens.length - availableTokens + i];
            }

            // í† í° ì°¨ê°
            gameState.tokens[goodType] = Math.max(0, availableTokens - count);

            // ë³´ë„ˆìŠ¤ ì ìˆ˜ ì¶”ê°€
            if (BONUS_POINTS[count]) {
                points += BONUS_POINTS[count];
            }

            return points;
        }

        /**
         * ì½”ì•Œë¼ ëª°ì´ (ì‹œì¥ì˜ ëª¨ë“  ì½”ì•Œë¼ ê°€ì ¸ì˜¤ê¸°)
         */
        function koalaRush() {
            if (!isMyTurn() || gameState.actionTaken) {
                alert('ì§€ê¸ˆì€ ì•¡ì…˜ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì‹œì¥ì—ì„œ ì½”ì•Œë¼ ê°œìˆ˜ í™•ì¸
            const koalaCount = gameState.market.filter(c => c === 'koala').length;

            if (koalaCount === 0) {
                alert('ì‹œì¥ì— ì½”ì•Œë¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const myHand = myPlayerId === 1 ? gameState.player1Hand : gameState.player2Hand;

            if (myHand.length + koalaCount > 7) {
                alert('ì½”ì•Œë¼ë¥¼ ëª¨ë‘ ê°€ì ¸ì˜¤ë©´ ì†íŒ¨ê°€ 7ì¥ì„ ì´ˆê³¼í•©ë‹ˆë‹¤.');
                return;
            }

            const action = { type: 'koalaRush' };

            if (isHost) {
                executeKoalaRush(action);
            } else {
                sendAction(action);
            }
        }

        /**
         * ì½”ì•Œë¼ ëª°ì´ ì‹¤í–‰ (Host)
         * @param {Object} action - ì•¡ì…˜ ê°ì²´
         */
        function executeKoalaRush(action) {
            const playerId = isHost ? (gameState.currentTurn === 1 ? 'player1Hand' : 'player2Hand') : 
                                      (gameState.currentTurn === 2 ? 'player2Hand' : 'player1Hand');
            const hand = gameState[playerId];

            // ì‹œì¥ì˜ ëª¨ë“  ì½”ì•Œë¼ ê°€ì ¸ì˜¤ê¸°
            for (let i = gameState.market.length - 1; i >= 0; i--) {
                if (gameState.market[i] === 'koala') {
                    hand.push(gameState.market[i]);
                    
                    // ì‹œì¥ ë³´ì¶©
                    if (gameState.deck.length > 0) {
                        gameState.market[i] = gameState.deck.shift();
                    } else {
                        gameState.market.splice(i, 1);
                    }
                }
            }

            // ì•¡ì…˜ ì™„ë£Œ
            gameState.selectedCards = { myHand: [], market: [] };
            gameState.actionTaken = true;

            sendGameState();
            renderGame();
        }

        /**
         * í„´ ì¢…ë£Œ
         */
        function endTurn() {
            if (!isMyTurn()) {
                alert('ë‹¹ì‹ ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤.');
                return;
            }

            if (!gameState.actionTaken) {
                alert('ì•¡ì…˜ì„ ë¨¼ì € ìˆ˜í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            const action = { type: 'endTurn' };

            if (isHost) {
                executeEndTurn(action);
            } else {
                sendAction(action);
            }
        }

        /**
         * í„´ ì¢…ë£Œ ì‹¤í–‰ (Host)
         * @param {Object} action - ì•¡ì…˜ ê°ì²´
         */
        function executeEndTurn(action) {
            // í„´ ë³€ê²½
            gameState.currentTurn = gameState.currentTurn === 1 ? 2 : 1;
            gameState.actionTaken = false;
            gameState.selectedCards = { myHand: [], market: [] };

            sendGameState();
            renderGame();
        }

        /**
         * Guest ì•¡ì…˜ ì²˜ë¦¬ (Host)
         * @param {Object} action - Guestê°€ ë³´ë‚¸ ì•¡ì…˜
         */
        function handleGuestAction(action) {
            if (!isHost) return;

            // ì•¡ì…˜ íƒ€ì…ë³„ ì²˜ë¦¬
            switch(action.type) {
                case 'take':
                    executeTakeCard(action);
                    break;
                case 'exchange':
                    executeExchange(action);
                    break;
                case 'sell':
                    executeSell(action);
                    break;
                case 'koalaRush':
                    executeKoalaRush(action);
                    break;
                case 'endTurn':
                    executeEndTurn(action);
                    break;
            }
        }

        /**
         * ê²Œì„ ì¢…ë£Œ ì¡°ê±´ ì²´í¬
         */
        function checkGameOver() {
            // ì¡°ê±´ 1: ìƒí’ˆ í† í° 3ì¢… ì†Œì§„
            const emptyTokens = Object.values(gameState.tokens).filter(v => v === 0).length;
            if (emptyTokens >= 3) {
                gameState.gameOver = true;
                return;
            }

            // ì¡°ê±´ 2: ë± ì†Œì§„
            if (gameState.deck.length === 0) {
                gameState.gameOver = true;
                return;
            }
        }

        /**
         * ê²Œì„ ì¢…ë£Œ í™”ë©´ í‘œì‹œ
         */
        function showGameOver() {
            const gameBoard = document.querySelector('.game-board');
            
            // ìŠ¹ì ê²°ì •
            let winner = '';
            if (gameState.player1Score > gameState.player2Score) {
                winner = 'í”Œë ˆì´ì–´ 1';
                gameState.player1Seals++;
            } else if (gameState.player2Score > gameState.player1Score) {
                winner = 'í”Œë ˆì´ì–´ 2';
                gameState.player2Seals++;
            } else {
                // ë™ì ì´ë©´ ìƒí’ˆ ì¹´ë“œê°€ ë” ë§ì€ í”Œë ˆì´ì–´
                const p1Goods = gameState.player1Hand.filter(c => c !== 'koala').length;
                const p2Goods = gameState.player2Hand.filter(c => c !== 'koala').length;
                
                if (p1Goods > p2Goods) {
                    winner = 'í”Œë ˆì´ì–´ 1';
                    gameState.player1Seals++;
                } else if (p2Goods > p1Goods) {
                    winner = 'í”Œë ˆì´ì–´ 2';
                    gameState.player2Seals++;
                } else {
                    winner = 'ë¬´ìŠ¹ë¶€';
                }
            }

            const gameOverHtml = `
                <div class="game-over">
                    <h2>ğŸ‰ ë¼ìš´ë“œ ì¢…ë£Œ!</h2>
                    <div class="winner">${winner === 'ë¬´ìŠ¹ë¶€' ? 'ğŸ¤ ë¬´ìŠ¹ë¶€!' : 'ğŸ† ' + winner + ' ìŠ¹ë¦¬!'}</div>
                    <p>í”Œë ˆì´ì–´ 1: ${gameState.player1Score}ì  (ğŸ† ${gameState.player1Seals}ê°œ)</p>
                    <p>í”Œë ˆì´ì–´ 2: ${gameState.player2Score}ì  (ğŸ† ${gameState.player2Seals}ê°œ)</p>
                    ${gameState.player1Seals >= 2 || gameState.player2Seals >= 2 ? 
                        '<h2>ğŸŠ ìµœì¢… ìŠ¹ì: ' + (gameState.player1Seals >= 2 ? 'í”Œë ˆì´ì–´ 1' : 'í”Œë ˆì´ì–´ 2') + '!</h2>' : 
                        '<button class="btn btn-primary" onclick="location.reload()">ë‹¤ìŒ ë¼ìš´ë“œ</button>'}
                </div>
            `;

            gameBoard.innerHTML += gameOverHtml;

            if (isHost) {
                sendGameState();
            }
        }

        // =============================================
        // ì´ˆê¸°í™”
        // =============================================
        
        console.log('ğŸ¨ Newsboy Koala Trader - Ready to play!');
    </script>
</body>
</html>
